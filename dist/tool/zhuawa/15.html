<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>15 | 一葦</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/icons/favicon.ico">
    <link rel="manifest" href="/blog/js/mainfest.json">
    <link rel="stylesheet" href="/blog/styles/css/style.css">
    <script type="utf-8" src="/blog/js/disable-user-zoom.js"></script>
    <meta name="description" content="这是一苇的前端技术博客哦~">
    <meta name="Author" content="一苇">
    <meta rel="keywords" content="verneyzhou,阿沐,一苇,前端,docs.verneyzhou-code.cn,博客,fe,IT,技术">
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta name="viewport" content="width=device-width,width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.61668f40.css" as="style"><link rel="preload" href="/blog/assets/js/app.76fa57e6.js" as="script"><link rel="preload" href="/blog/assets/js/3.a2a245ac.js" as="script"><link rel="preload" href="/blog/assets/js/210.8af7e1c3.js" as="script"><link rel="preload" href="/blog/assets/js/4.245b4373.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2c3fb9b8.js"><link rel="prefetch" href="/blog/assets/js/100.84bf5092.js"><link rel="prefetch" href="/blog/assets/js/101.6b905b71.js"><link rel="prefetch" href="/blog/assets/js/102.7ece9162.js"><link rel="prefetch" href="/blog/assets/js/103.01775736.js"><link rel="prefetch" href="/blog/assets/js/104.c9b72bdf.js"><link rel="prefetch" href="/blog/assets/js/105.b7ceaf1e.js"><link rel="prefetch" href="/blog/assets/js/106.5321c092.js"><link rel="prefetch" href="/blog/assets/js/107.dfde808a.js"><link rel="prefetch" href="/blog/assets/js/108.76e55255.js"><link rel="prefetch" href="/blog/assets/js/109.b6b8f78e.js"><link rel="prefetch" href="/blog/assets/js/11.d8db7424.js"><link rel="prefetch" href="/blog/assets/js/110.03440fcf.js"><link rel="prefetch" href="/blog/assets/js/111.7001d092.js"><link rel="prefetch" href="/blog/assets/js/112.2c3ec8a9.js"><link rel="prefetch" href="/blog/assets/js/113.17aec38b.js"><link rel="prefetch" href="/blog/assets/js/114.d5c86b19.js"><link rel="prefetch" href="/blog/assets/js/115.c5e7ed6d.js"><link rel="prefetch" href="/blog/assets/js/116.c48f3f00.js"><link rel="prefetch" href="/blog/assets/js/117.46f33ca4.js"><link rel="prefetch" href="/blog/assets/js/118.891ade5b.js"><link rel="prefetch" href="/blog/assets/js/119.58a54ba4.js"><link rel="prefetch" href="/blog/assets/js/12.b6309f61.js"><link rel="prefetch" href="/blog/assets/js/120.e96a1ea7.js"><link rel="prefetch" href="/blog/assets/js/121.ba217794.js"><link rel="prefetch" href="/blog/assets/js/122.fa395dd6.js"><link rel="prefetch" href="/blog/assets/js/123.8dee52e0.js"><link rel="prefetch" href="/blog/assets/js/124.5964facb.js"><link rel="prefetch" href="/blog/assets/js/125.2b5713d4.js"><link rel="prefetch" href="/blog/assets/js/126.0b020030.js"><link rel="prefetch" href="/blog/assets/js/127.73d8db3a.js"><link rel="prefetch" href="/blog/assets/js/128.e350bccb.js"><link rel="prefetch" href="/blog/assets/js/129.6efe4916.js"><link rel="prefetch" href="/blog/assets/js/13.8df65d8d.js"><link rel="prefetch" href="/blog/assets/js/130.2feb4a2a.js"><link rel="prefetch" href="/blog/assets/js/131.ebf7c589.js"><link rel="prefetch" href="/blog/assets/js/132.2fd4ea82.js"><link rel="prefetch" href="/blog/assets/js/133.e9db689a.js"><link rel="prefetch" href="/blog/assets/js/134.8c37cc25.js"><link rel="prefetch" href="/blog/assets/js/135.ae783483.js"><link rel="prefetch" href="/blog/assets/js/136.92671aff.js"><link rel="prefetch" href="/blog/assets/js/137.0db285b2.js"><link rel="prefetch" href="/blog/assets/js/138.c73abe07.js"><link rel="prefetch" href="/blog/assets/js/139.41626f14.js"><link rel="prefetch" href="/blog/assets/js/14.b950268f.js"><link rel="prefetch" href="/blog/assets/js/140.99fdcd5c.js"><link rel="prefetch" href="/blog/assets/js/141.fbc8e614.js"><link rel="prefetch" href="/blog/assets/js/142.4f34e195.js"><link rel="prefetch" href="/blog/assets/js/143.127a9850.js"><link rel="prefetch" href="/blog/assets/js/144.0f65824d.js"><link rel="prefetch" href="/blog/assets/js/145.1ee8c5fc.js"><link rel="prefetch" href="/blog/assets/js/146.3ba627c8.js"><link rel="prefetch" href="/blog/assets/js/147.09e3708c.js"><link rel="prefetch" href="/blog/assets/js/148.5e218851.js"><link rel="prefetch" href="/blog/assets/js/149.0e52c725.js"><link rel="prefetch" href="/blog/assets/js/15.030ef122.js"><link rel="prefetch" href="/blog/assets/js/150.d3ae11a8.js"><link rel="prefetch" href="/blog/assets/js/151.817b960d.js"><link rel="prefetch" href="/blog/assets/js/152.5a77e7f4.js"><link rel="prefetch" href="/blog/assets/js/153.5bc9a462.js"><link rel="prefetch" href="/blog/assets/js/154.d4c7af79.js"><link rel="prefetch" href="/blog/assets/js/155.dc03710e.js"><link rel="prefetch" href="/blog/assets/js/156.5e872d85.js"><link rel="prefetch" href="/blog/assets/js/157.9e2becea.js"><link rel="prefetch" href="/blog/assets/js/158.a2942e85.js"><link rel="prefetch" href="/blog/assets/js/159.26c63404.js"><link rel="prefetch" href="/blog/assets/js/16.cfb1a53b.js"><link rel="prefetch" href="/blog/assets/js/160.96d3beaa.js"><link rel="prefetch" href="/blog/assets/js/161.c34c5b2e.js"><link rel="prefetch" href="/blog/assets/js/162.45223b4c.js"><link rel="prefetch" href="/blog/assets/js/163.dca039a1.js"><link rel="prefetch" href="/blog/assets/js/164.c188755b.js"><link rel="prefetch" href="/blog/assets/js/165.774591a1.js"><link rel="prefetch" href="/blog/assets/js/166.0bb7199e.js"><link rel="prefetch" href="/blog/assets/js/167.6c729c82.js"><link rel="prefetch" href="/blog/assets/js/168.9ddae43f.js"><link rel="prefetch" href="/blog/assets/js/169.a041747e.js"><link rel="prefetch" href="/blog/assets/js/17.7f17682b.js"><link rel="prefetch" href="/blog/assets/js/170.b70b623c.js"><link rel="prefetch" href="/blog/assets/js/171.4b0257b9.js"><link rel="prefetch" href="/blog/assets/js/172.7f4c2d3c.js"><link rel="prefetch" href="/blog/assets/js/173.b3b75dfa.js"><link rel="prefetch" href="/blog/assets/js/174.52d7ea40.js"><link rel="prefetch" href="/blog/assets/js/175.beb33995.js"><link rel="prefetch" href="/blog/assets/js/176.95e06720.js"><link rel="prefetch" href="/blog/assets/js/177.f491f17d.js"><link rel="prefetch" href="/blog/assets/js/178.71c66889.js"><link rel="prefetch" href="/blog/assets/js/179.ca760d60.js"><link rel="prefetch" href="/blog/assets/js/18.cbfdeb09.js"><link rel="prefetch" href="/blog/assets/js/180.b50d733c.js"><link rel="prefetch" href="/blog/assets/js/181.335287be.js"><link rel="prefetch" href="/blog/assets/js/182.8cad2bdb.js"><link rel="prefetch" href="/blog/assets/js/183.37a5fb7a.js"><link rel="prefetch" href="/blog/assets/js/184.e920bd7f.js"><link rel="prefetch" href="/blog/assets/js/185.0ffd8f98.js"><link rel="prefetch" href="/blog/assets/js/186.b9b7e58a.js"><link rel="prefetch" href="/blog/assets/js/187.ee242116.js"><link rel="prefetch" href="/blog/assets/js/188.a7f885d1.js"><link rel="prefetch" href="/blog/assets/js/189.41087ead.js"><link rel="prefetch" href="/blog/assets/js/19.355e9671.js"><link rel="prefetch" href="/blog/assets/js/190.0ff0d636.js"><link rel="prefetch" href="/blog/assets/js/191.b0c298a8.js"><link rel="prefetch" href="/blog/assets/js/192.e1fdc41d.js"><link rel="prefetch" href="/blog/assets/js/193.a12e8cc4.js"><link rel="prefetch" href="/blog/assets/js/194.552a7d72.js"><link rel="prefetch" href="/blog/assets/js/195.65c94003.js"><link rel="prefetch" href="/blog/assets/js/196.7ecad629.js"><link rel="prefetch" href="/blog/assets/js/197.769eb8f4.js"><link rel="prefetch" href="/blog/assets/js/198.417e877e.js"><link rel="prefetch" href="/blog/assets/js/199.c198e821.js"><link rel="prefetch" href="/blog/assets/js/20.925de35d.js"><link rel="prefetch" href="/blog/assets/js/200.aaf0c7da.js"><link rel="prefetch" href="/blog/assets/js/201.b9b528a4.js"><link rel="prefetch" href="/blog/assets/js/202.dc2130c4.js"><link rel="prefetch" href="/blog/assets/js/203.494c16a2.js"><link rel="prefetch" href="/blog/assets/js/204.5451a8b2.js"><link rel="prefetch" href="/blog/assets/js/205.3a9d9143.js"><link rel="prefetch" href="/blog/assets/js/206.8f218f53.js"><link rel="prefetch" href="/blog/assets/js/207.e286efec.js"><link rel="prefetch" href="/blog/assets/js/208.b15e7ceb.js"><link rel="prefetch" href="/blog/assets/js/209.8be13a1b.js"><link rel="prefetch" href="/blog/assets/js/21.73aa97dc.js"><link rel="prefetch" href="/blog/assets/js/211.cf4f7aba.js"><link rel="prefetch" href="/blog/assets/js/212.b1e8078a.js"><link rel="prefetch" href="/blog/assets/js/213.99b7c2dd.js"><link rel="prefetch" href="/blog/assets/js/214.3073fbf3.js"><link rel="prefetch" href="/blog/assets/js/215.7884f71b.js"><link rel="prefetch" href="/blog/assets/js/216.fc4df39d.js"><link rel="prefetch" href="/blog/assets/js/217.dcf694ab.js"><link rel="prefetch" href="/blog/assets/js/218.91ac665b.js"><link rel="prefetch" href="/blog/assets/js/219.04f0e072.js"><link rel="prefetch" href="/blog/assets/js/22.a5e696f3.js"><link rel="prefetch" href="/blog/assets/js/220.ec5aa358.js"><link rel="prefetch" href="/blog/assets/js/221.eeacfb35.js"><link rel="prefetch" href="/blog/assets/js/222.6d68084c.js"><link rel="prefetch" href="/blog/assets/js/223.6d1ff62a.js"><link rel="prefetch" href="/blog/assets/js/224.b1682e38.js"><link rel="prefetch" href="/blog/assets/js/23.e58011e2.js"><link rel="prefetch" href="/blog/assets/js/24.9a66d8cd.js"><link rel="prefetch" href="/blog/assets/js/25.bbfbc411.js"><link rel="prefetch" href="/blog/assets/js/26.0a58cb04.js"><link rel="prefetch" href="/blog/assets/js/27.30ff8122.js"><link rel="prefetch" href="/blog/assets/js/28.1b138f63.js"><link rel="prefetch" href="/blog/assets/js/29.8706dde6.js"><link rel="prefetch" href="/blog/assets/js/30.7354bbdd.js"><link rel="prefetch" href="/blog/assets/js/31.42f329d7.js"><link rel="prefetch" href="/blog/assets/js/32.89b2e87d.js"><link rel="prefetch" href="/blog/assets/js/33.e762c9a2.js"><link rel="prefetch" href="/blog/assets/js/34.c4cc6afc.js"><link rel="prefetch" href="/blog/assets/js/35.a3e5fba6.js"><link rel="prefetch" href="/blog/assets/js/36.03e0ebe8.js"><link rel="prefetch" href="/blog/assets/js/37.ec453e24.js"><link rel="prefetch" href="/blog/assets/js/38.cf1f5fcf.js"><link rel="prefetch" href="/blog/assets/js/39.1156b141.js"><link rel="prefetch" href="/blog/assets/js/40.d33ba184.js"><link rel="prefetch" href="/blog/assets/js/41.2820e583.js"><link rel="prefetch" href="/blog/assets/js/42.c088f38a.js"><link rel="prefetch" href="/blog/assets/js/43.a832abeb.js"><link rel="prefetch" href="/blog/assets/js/44.9391c80d.js"><link rel="prefetch" href="/blog/assets/js/45.a0235304.js"><link rel="prefetch" href="/blog/assets/js/46.9730b825.js"><link rel="prefetch" href="/blog/assets/js/47.56fd5076.js"><link rel="prefetch" href="/blog/assets/js/48.b5374317.js"><link rel="prefetch" href="/blog/assets/js/49.8bb025d5.js"><link rel="prefetch" href="/blog/assets/js/5.32a2e1b6.js"><link rel="prefetch" href="/blog/assets/js/50.8011aa1f.js"><link rel="prefetch" href="/blog/assets/js/51.a915dbc4.js"><link rel="prefetch" href="/blog/assets/js/52.99d2399f.js"><link rel="prefetch" href="/blog/assets/js/53.be187caf.js"><link rel="prefetch" href="/blog/assets/js/54.07b08901.js"><link rel="prefetch" href="/blog/assets/js/55.3ef99688.js"><link rel="prefetch" href="/blog/assets/js/56.9258b8d8.js"><link rel="prefetch" href="/blog/assets/js/57.4762d5e6.js"><link rel="prefetch" href="/blog/assets/js/58.8d1268be.js"><link rel="prefetch" href="/blog/assets/js/59.20eb3b71.js"><link rel="prefetch" href="/blog/assets/js/6.9db196de.js"><link rel="prefetch" href="/blog/assets/js/60.0adc2f64.js"><link rel="prefetch" href="/blog/assets/js/61.7a4bb849.js"><link rel="prefetch" href="/blog/assets/js/62.4b595b7b.js"><link rel="prefetch" href="/blog/assets/js/63.8efe6050.js"><link rel="prefetch" href="/blog/assets/js/64.2daf2555.js"><link rel="prefetch" href="/blog/assets/js/65.01aa6930.js"><link rel="prefetch" href="/blog/assets/js/66.b71e30c2.js"><link rel="prefetch" href="/blog/assets/js/67.b88d5dfc.js"><link rel="prefetch" href="/blog/assets/js/68.0455a3ce.js"><link rel="prefetch" href="/blog/assets/js/69.aac22b54.js"><link rel="prefetch" href="/blog/assets/js/7.c958551b.js"><link rel="prefetch" href="/blog/assets/js/70.513be29f.js"><link rel="prefetch" href="/blog/assets/js/71.dda331fc.js"><link rel="prefetch" href="/blog/assets/js/72.20dc430c.js"><link rel="prefetch" href="/blog/assets/js/73.5046c7ef.js"><link rel="prefetch" href="/blog/assets/js/74.436c2c94.js"><link rel="prefetch" href="/blog/assets/js/75.717953f1.js"><link rel="prefetch" href="/blog/assets/js/76.4898deac.js"><link rel="prefetch" href="/blog/assets/js/77.1417b15d.js"><link rel="prefetch" href="/blog/assets/js/78.d51e77f9.js"><link rel="prefetch" href="/blog/assets/js/79.e7af2572.js"><link rel="prefetch" href="/blog/assets/js/8.d5f2c1ba.js"><link rel="prefetch" href="/blog/assets/js/80.f5d5c456.js"><link rel="prefetch" href="/blog/assets/js/81.e46213a6.js"><link rel="prefetch" href="/blog/assets/js/82.a2b78450.js"><link rel="prefetch" href="/blog/assets/js/83.ec57022e.js"><link rel="prefetch" href="/blog/assets/js/84.1a1e65b2.js"><link rel="prefetch" href="/blog/assets/js/85.453ecac0.js"><link rel="prefetch" href="/blog/assets/js/86.98f2e40a.js"><link rel="prefetch" href="/blog/assets/js/87.56486cd5.js"><link rel="prefetch" href="/blog/assets/js/88.25a76bc5.js"><link rel="prefetch" href="/blog/assets/js/89.0a157175.js"><link rel="prefetch" href="/blog/assets/js/9.952385f9.js"><link rel="prefetch" href="/blog/assets/js/90.5b516e54.js"><link rel="prefetch" href="/blog/assets/js/91.6d74ff97.js"><link rel="prefetch" href="/blog/assets/js/92.3b2d151b.js"><link rel="prefetch" href="/blog/assets/js/93.f20ce1f2.js"><link rel="prefetch" href="/blog/assets/js/94.c3062efe.js"><link rel="prefetch" href="/blog/assets/js/95.206ed12d.js"><link rel="prefetch" href="/blog/assets/js/96.fad1a27d.js"><link rel="prefetch" href="/blog/assets/js/97.23b93196.js"><link rel="prefetch" href="/blog/assets/js/98.a90f6f17.js"><link rel="prefetch" href="/blog/assets/js/99.adc32b70.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.381052ad.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.61668f40.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar have-rightmenu"><!----> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="images/poster03.jpeg"> <div class="blogger-info"><h3></h3> <span>是旷野，不是轨道哦，少年。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/archives/" class="nav-link">时间轴</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><!----> <span class="title" style="display:;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/js/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/css/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><!----> <span class="title" style="display:;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/skills/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/skills/webpack/" class="nav-link">Webpack</a></li><li class="dropdown-item"><!----> <a href="/blog/code/" class="nav-link">源码</a></li><li class="dropdown-item"><!----> <a href="/blog/more/web3/" class="nav-link">Web3</a></li><li class="dropdown-item"><!----> <a href="/blog/more/" class="nav-link">更多</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><!----> <span class="title" style="display:;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>PC端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/vue-node-admin/" class="nav-link">vue-node-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-vite-admin.html" class="nav-link">vue3-vite-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-cli-admin.html" class="nav-link">vue3-cli-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-webpack5-admin.html" class="nav-link">vue3-webpack5-admin</a></li><li class="dropdown-subitem"><a href="/blog/project/mono-react-project.html" class="nav-link">teach-react-mono</a></li></ul></li><li class="dropdown-item"><h4>移动端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/mobile-h5/" class="nav-link">微信h5</a></li><li class="dropdown-subitem"><a href="/blog/project/mini-program/" class="nav-link">微信小程序</a></li><li class="dropdown-subitem"><a href="/blog/project/mobile/" class="nav-link">移动端开发笔记</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/more/ai/" class="nav-link">AI</a></div><div class="nav-item"><a href="/blog/tool/" class="nav-link router-link-active">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><!----> <span class="title" style="display:;">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/about/" class="nav-link">ME</a></li><li class="dropdown-item"><!----> <a href="https://github.com/verneyZhou" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><!----> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">15<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="nodejs"><a href="#nodejs" class="header-anchor">#</a> NodeJs</h1> <h2 id="nodejs基础"><a href="#nodejs基础" class="header-anchor">#</a> NodeJs基础</h2> <p>Node.js 是一个开源的、跨平台的 JavaScript 运行时环境。</p> <ul><li>NodeJs特点：</li></ul> <ol><li><strong>异步非阻塞模型</strong>： Node.js采用了异步非阻塞的事件驱动模型，这使得它能够<strong>在单个线程上处理大量并发请求</strong>。相比之下，许多传统的后端语言（如Java、Python）通常采用多线程或多进程模型来处理并发，这可能会导致更大的系统资源消耗和开发复杂性。</li> <li><strong>性能</strong>： Node.js的异步模型和事件循环使其<strong>在处理I/O密集型任务（如网络请求、文件操作）方面表现出色</strong>。然而，对于计算密集型任务，其他编译型语言（如Java、C#）可能会更有优势。</li> <li>解释型语言</li></ol> <blockquote><p>Node.js底层是用C++编写，它使用了V8的开源引擎来执行JavaScript代码。V8引擎是由Google开发的，它主要用于将JavaScript代码编译成本地机器代码，以提高执行速度。Node.js还使用了libuv库来处理事件循环、异步I/O等操作，这使得Node.js能够实现非阻塞式的、高性能的网络应用程序。</p></blockquote> <p>Node.js底层的实现包括两个主要组件：</p> <ol><li><strong>V8引擎</strong>: 这是一个高性能的JavaScript引擎，<strong>负责将JavaScript代码编译成机器码并执行</strong>。它是Node.js的核心组件，使得Node.js能够运行JavaScript代码。</li> <li><strong>libuv库</strong>: 这是一个跨平台的库，用于处理事件循环、异步I/O、文件系统操作等。它<strong>提供了对底层操作系统API的封装</strong>，使得Node.js可以实现非阻塞式的异步操作，从而达到高性能和高并发的目标。</li></ol> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <p>Node.js 中的事件循环则是自己实现的，基于 Ryan Dahl 开发的 libuv ，完成了事件循环与异步 I/O。</p> <img src="/blog/images/tool/zhuawa-node01.png" width="auto" class="zoom-custom-imgs"> <ul><li>Event Loop:</li></ul> <img src="/blog/images/tool/zhuawa-node02.png" width="auto" class="zoom-custom-imgs"> <p><strong>setImmediate()</strong></p> <ul><li>setImmediate 用于在当前事件循环迭代的末尾安排一个回调函数执行。它会在事件循环的 &quot;check&quot; 阶段执行。</li> <li>当你想要在 I/O 操作完成后尽快执行回调时，setImmediate 是一个很好的选择。</li></ul> <p><strong>process.nextTick()</strong></p> <ul><li>process.nextTick()是一个特殊的异步API，他不属于任何的Event Loop阶段。事实上Node在遇到这个API时，Event Loop根本就不会继续进行，会马上停下来执行process.nextTick()</li></ul> <p><strong>queueMicrotask()</strong></p> <ul><li>queueMicrotask 用于将一个微任务（microtask）添加到微任务队列中，在当前事件循环迭代的末尾执行。微任务在 I/O 之后、事件循环阶段之前执行。</li> <li>微任务通常用于需要尽快执行的、与 I/O 无关的操作，例如 promise 的回调函数。</li> <li>queueMicrotask 的优先级介于 process.nextTick 和 setImmediate 之间。</li></ul> <ol><li>在一个异步流程里，setImmediate会比定时器先执行</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// n.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'outer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// node n.js</span>

<span class="token comment">// outer &gt; setImmediate &gt; setTimeout</span>
</code></pre></div><ol start="2"><li>setTimeout(fn, 1)  <a href="https://nodejs.org/api/timers.html#timers_settimeout_callback_delay_args" target="_blank" rel="noopener noreferrer">https://nodejs.org/api/timers.html#timers_settimeout_callback_delay_args<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <blockquote><p><code>setTimeout</code>最小就是<code>1ms</code>,就算设置为<code>0</code>, 也是按<code>1</code>算~</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// n.js</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'outer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// setTimeout(fn, 1)</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// node n.js</span>
<span class="token comment">// 执行时长 &gt; 0.001s ：outer &gt; seTimeout &gt; setImmediate</span>
<span class="token comment">// 执行时长 &lt; 0.001s ：outer &gt; setImmediate &gt; seTimeout</span>


<span class="token comment">// </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'outer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// </span>
</code></pre></div><ul><li>一个例子：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 特殊的异步API，会马上停下来执行process.nextTick()</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 放在 check 队列里面</span>
     <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 放在 check 队列里面</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 放在 timer 队列里面</span>
<span class="token comment">// js执行已经超过0.001s,所以先执行 timer 队列里面的</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">+</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">+</span><span class="token string">'promise+then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 放在 timer 队列里面</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 放在 check 队列里面</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'13'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'14'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 放在微任务队列里面</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 微任务</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">/**
执行顺序：
14
15
1
2
4
16
8
8promise
8promise+then
9
5
6
10
11
12
3
7
13
 */</span>

</code></pre></div><p>分析：</p> <ol><li>首先顺序执行: 将<code>process.nextTick</code>是放在微任务队列中，不立即执行；异步任务放在<code>check/timer</code>队列中；执行同步任务：<code>14, 15</code>, 把微任务<code>Promise</code>放在微任务队列中；</li> <li>然后执行 <code>process.nextTick</code>：<code>1,2,4</code>, <code>3</code>放在<code>check</code>队列中，执行Promise微任务: <code>16</code>；</li> <li>然后执行timer队列：<code>8, 8+'promise'</code>, 之后继续执行唯一的微任务：<code>8+'promise+then'</code>; 之后继续执行timer队列：<code>9</code>;</li> <li>然后开始执行check队列：<code>5,6</code>, 把<code>7</code>追加到check队列后面；之后继续执行第二个check任务：<code>10,11,12</code>, 把<code>13</code>追加到check队列后面；之后执行第三个check任务：<code>3</code>; 最后顺序执行追加的check任务：<code>7,13</code></li></ol> <h3 id="require"><a href="#require" class="header-anchor">#</a> Require</h3> <ul><li>一个例子：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">const</span> getMes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是 a 文件'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">getMes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token comment">// const say = require('./a')</span>
<span class="token comment">// const  object = {</span>
<span class="token comment">//    name:'《React》',</span>
<span class="token comment">//    author:'Rico'</span>
<span class="token comment">// }</span>
<span class="token comment">// console.log('我是 b 文件')</span>
<span class="token comment">// module.exports = function(){</span>
<span class="token comment">//     return object</span>
<span class="token comment">// }</span>

<span class="token keyword">const</span> say <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span>  object <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React》'</span><span class="token punctuation">,</span>
   <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'Rico'</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是 b 文件'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'打印 a 模块'</span> <span class="token punctuation">,</span> say<span class="token punctuation">)</span> <span class="token comment">// 打印 a 模块 {}:  a模块还没执行完，所以打印出来的是空对象</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异步打印 a 模块'</span> <span class="token punctuation">,</span> say<span class="token punctuation">)</span> <span class="token comment">// 异步打印 a 模块 { say: [Function] }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> object
<span class="token punctuation">}</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'node 入口文件'</span><span class="token punctuation">)</span>


<span class="token comment">// node main.js</span>
<span class="token comment">/**
我是 b 文件
打印 a 模块 {}
我是 a 文件
node 入口文件
异步打印 a 模块 { say: [Function (anonymous)] }
 */</span>
</code></pre></div><blockquote><p>main.js 和 a.js 模块都引用了 b.js 模块，但是 b.js 模块只执行了一次。</p></blockquote> <blockquote><p>a.js 模块 和 b.js 模块互相引用，但是没有造成<strong>循环引用</strong>的情况。</p></blockquote> <p><code>module</code> 和 <code>Module</code>:</p> <ol><li><code>module</code> ：在 Node 中每一个 js 文件都是一个 module ，module 上保存了 exports 等信息之外，还有一个 loaded 表示该模块是否被加载。</li></ol> <ul><li>为 false 表示还没有加载；</li> <li>为 true 表示已经加载</li></ul> <ol start="2"><li><code>Module</code> ：以 nodejs 为例，整个系统运行之后，会用 Module 缓存每一个模块加载的信息。</li></ol> <ul><li>require原理伪代码:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// id 为路径标识符</span>
<span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">/* 查找  Module 上有没有已经加载的 js  对象*/</span>
   <span class="token keyword">const</span>  cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
   
   <span class="token comment">/* 如果已经加载了那么直接取走缓存的 exports 对象  */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>cachedModule<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports
  <span class="token punctuation">}</span>
 
  <span class="token comment">/* 创建当前模块的 module  */</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">,</span><span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">}</span>

  <span class="token comment">/* 将 module 缓存到  Module 的缓存属性中，路径标识符作为 id */</span>  
  Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> module
  <span class="token comment">/* 加载文件 */</span>
  <span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token string">'module.exports = &quot;123&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span>
  <span class="token comment">/* 加载完成 */</span><span class="token operator">/</span>
  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span> 
  <span class="token comment">/* 返回值 */</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">执行流程</p> <ol><li>首先执行 <code>node main.js</code> ，那么开始执行第一行 <code>require(a.js)</code>；</li> <li>那么首先判断 a.js 有没有缓存，因为没有缓存，先加入缓存，然后执行文件 a.js （<strong>需要注意 是先加入缓存， 后执行模块内容</strong>）;</li> <li>a.js 中执行第一行，引用 b.js。</li> <li>那么判断 b.js 有没有缓存，因为没有缓存，所以加入缓存，然后执行 b.js 文件。</li> <li>b.js 执行第一行，再一次循环引用 <code>require(a.js)</code> 此时的 a.js 已经加入缓存，直接读取值。接下来打印 <code>console.log('我是 b 文件')</code>，导出方法。</li> <li>b.js 执行完毕，回到 a.js 文件，打印 <code>console.log('我是 a 文件')</code>，导出方法。</li> <li>最后回到 main.js，打印 <code>console.log('node 入口文件')</code> 完成这个流程。</li></ol></div> <img src="/blog/images/tool/zhuawa-node03.png" width="auto" class="zoom-custom-imgs"> <p>Node.js 中 CommonJS 模块的本质:</p> <blockquote><p>在 Node.js 中，CommonJS 的加载过程是由路径到源码，再到函数，最后通过执行函数注入灵魂，这某种意义上其实是返璞归真——IIFE</p></blockquote> <h3 id="commonjs-与-esm"><a href="#commonjs-与-esm" class="header-anchor">#</a> CommonJS 与 ESM</h3> <p>通常一个 <code>*.mjs</code> 会被认为是 <code>ECMAScript module</code>，而一个 <code>*.cjs</code> 则会被认为是 <code>CommonJS</code> 模块。</p> <blockquote><p>如果是 <code>*.js</code> 文件，则需要看离它最近的父 package.json 文件。这个就涉及到 Node.js 的包机制了，后续章节中会提。Node.js 在 v12.0.0 中，为 package.json 增加了 type 字段，用于判别其麾下的 *.js 文件是 ECMAScript module 还是 CommonJS 模块。若 type 值为 <code>module</code>，则其 <code>*.js</code> 为 <code>ECMAScript module</code>；若其值为 commonjs 或者不存在该值，则其 *.js 为 CommonJS 模块。</p></blockquote> <p><strong>ECMAScript Modules 又称 ES Modules，缩写 ESM</strong>。它的设计非常“精简”与“官方”，从语法层面就完成了对模块的定义。像 CommonJS 也好，AMD、CMD 等也罢，都是通过三方实现函数和对象来模拟模块，而 ESM 则直接通过 import 与 export 语法来导入和导出模块。</p> <ul><li><p>CommonJS 是运行时做的模块加载和运行，它可以在代码执行一半的时候以动态的方式加载，这种方法在一些静态分析的时候会造成阻碍。</p></li> <li><p>而 ESM 则是在模块顶部以语法的形式加载模块，完全可以做静态分析。</p></li></ul> <p>CommonJS 与 ECMAScript module 虽然是两套模块机制，但在 Node.js 中一定程度上是可以互通的:</p> <ol><li><code>CommonJS</code> 下无法使用 import 语法，<code>ECMAScript module</code> 中没有 <code>require()</code>；</li> <li><code>ECMAScript module</code> 可以 <code>import CommonJS</code> 模块；</li> <li>CommonJS 模块无法 <code>require()</code> ECMAScript module，但可以通过 <code>import()</code> 语法动态加载它。</li></ol> <h3 id="npm生态"><a href="#npm生态" class="header-anchor">#</a> NPM生态</h3> <blockquote><p>Node.js Package Manager   =&gt;  JavaScript Package Manager</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.2.3 - 2.3.4&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 区间匹配: 表示匹配的版本需要在区间中间。如 1.2.3 - 2.3.4 代表 &gt;= 1.2.3 &lt;= 2.3.4</span>
    <span class="token property">&quot;bar&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;=1.0.2 &lt;2.1.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;：小于某个版本, &gt;=：大于等于某个版本</span>
    <span class="token property">&quot;baz&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;1.0.2 &lt;=2.3.4&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &gt;：大于某个版本, &lt;=：小于等于某个版本</span>
    <span class="token property">&quot;boo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.0.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 精确匹配, =, 固定版本</span>
    <span class="token property">&quot;qux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;1.0.0 || &gt;=2.3.1 &lt;2.4.5 || &gt;=2.5.2 &lt;3.0.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// || 或</span>
    <span class="token property">&quot;asd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://asdf.com/asdf.tar.gz&quot;</span><span class="token punctuation">,</span>

    <span class="token comment">// 波浪匹配和上箭头匹配是最常见的 SemVer 匹配范围表示了</span>
    <span class="token comment">// 波浪匹配不允许动主次版本号，以修订版本号为最低匹配版本号去匹配。</span>
    <span class="token property">&quot;til&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~1.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ~1.2 则说明 &gt;= 1.2.0 &lt; 1.3.0-0，即等同于 1.2 或 1.2.x</span>
    <span class="token property">&quot;elf&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~1.2.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 如 ~1.2.3 则说明 &gt;= 1.2.3 &lt; 1.3.0-0</span>
    <span class="token property">&quot;dfd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~0.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ~0.2 表示 &gt;= 0.2.0 &lt; 0.3.0-0。</span>
    <span class="token property">&quot;sds&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 只指定了主版本号，则将版本限定为对应主版本号下的所有版本号: ~0 表示 &gt;= 0.0.0 &lt; 1.0.0-0。</span>

    <span class="token property">&quot;two&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.x&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 代表 2 为主版本的任意版本（&gt;= 2.0.0 &lt; 3.0.0-0）</span>
    <span class="token property">&quot;thr&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.2.x&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 代表 1.2 为主次版本的任意版本（&gt;= 1.2.0 &lt; 1.3.0-0）</span>
    
    <span class="token comment">// 上箭头匹配表示第一个非零版本段后面的版本段可被升级</span>
    <span class="token comment">// 第一个非零版本段是主版本号，它后面的版本段是次版本号，也就说可匹配大于该版本号的所有该主版本号下的版本号</span>
    <span class="token property">&quot;dadsa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.2.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">//  &gt;= 1.2.3 &lt; 2.0.0-0；</span>
    <span class="token property">&quot;dsfs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.0.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">//  只能匹配该修订号下所有先行版本号，即 &gt;= 0.0.3 &lt; 0.0.4-0。</span>
    <span class="token property">&quot;hgfd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.2.3-beta.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &gt;= 1.2.3-beta.2 &lt; 2.0.0-0</span>
    <span class="token property">&quot;fsdfsd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.0.3-beta.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &gt;= 0.0.3-beta.2 &lt; 0.0.4-0</span>
    <span class="token property">&quot;fsds&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>

    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dyl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;file:../dyl&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;xfd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span> <span class="token comment">// 通配, * 代表任意版本（&gt;= 0.0.0）</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>所有不带先行版本号的 SemVer 版本都比对应版本加上任意先行版本号的 SemVer 版本大，即 <code>1.0.0</code> 是大于 <code>1.0.0-&lt;xxx&gt;</code> 的。</p></blockquote> <h3 id="npm-yarn-pnpm"><a href="#npm-yarn-pnpm" class="header-anchor">#</a> npm / yarn / pnpm</h3> <p><strong>npm</strong></p> <p>选择使用每个包管理器的方式会有所不同，但它们都有基本一致的概念。以上这些包管理器都可以执行以下指令：</p> <ul><li>读写数据</li> <li>批量安装或更新所有依赖项</li> <li>添加、更新和删除依赖项</li> <li>运行脚本</li> <li>发布包</li></ul> <ol><li><p>npm2递归结构: 包冗余，包会很大</p></li> <li><p>npm3 扁平结构：同名但不同版本的包是两个独立的包，而同层不能有两个同名子目录</p></li> <li><p>npm5 lock锁: Yarn 首次引入的  =&gt; npm5借鉴</p></li></ol> <p>npm为了让开发者在安全的前提下使用最新的依赖包，在package.json中通常做了锁定大版本的操作，这样在每次npm install的时候都会拉取依赖包大版本下的最新的版本。这种机制最大的一个缺点就是当有依赖包有小版本更新时，可能会出现协同开发者的依赖包不一致的问题</p> <p><code>package-lock.json</code>文件精确描述了node_modules 目录下所有的包的树状依赖结构，每个包的版本号都是完全精确的</p> <p><strong>只要有这样一个 lock 文件，不管在哪一台机器上执行 npm install 都会得到完全相同的 node_modules 结果</strong>。</p> <blockquote><p>本地开发完成之后，CI平台会根据lock文件，拿到和本地完全一致的node modules</p></blockquote> <p><strong>yarn</strong></p> <p>Q: 为什么更快？</p> <ol><li><strong>并行安装</strong>：无论 npm 还是 Yarn 在执行包的安装时，都会执行一系列任务。<strong>npm 是按照队列执行每个 package</strong>，也就是说必须要等到当前 package 安装完成之后，才能继续后面的安装。而 <strong>Yarn 是同步执行所有任务，提高了性能</strong></li> <li><strong>离线模式</strong>：如果之前已经安装过一个软件包，用Yarn再次安装时之间从缓存中获取，就不用像npm那样再从网络下载了</li></ol> <ul><li>yarn2  berry</li></ul> <p>在使用<code>yarn 2.x</code>安装以后，node_modules不会再出现，代替它的是<code>.yarn</code>目录，里面有<code>cache</code>和<code>unplugged</code>两个目录，以及外面一个<code>.pnp.js</code></p> <ul><li><code>.yarn/cache</code>里面放所有需要的依赖的压缩包，<code>zip</code>格式</li> <li><code>.yarn/unplugged</code>是你需要手动去修改的依赖，使用<code>yarn unplugin lodash</code>可以把<code>lodash</code>解压到这个目录下，之后想修改什么的随意</li> <li><code>.pnp.js</code>是PNP功能的核心，所有的依赖定位都需要通过它来</li></ul> <p><strong>pnpm</strong></p> <p>pnpm 有一个 store 的概念，store 目录内部使用「<strong>基于内容寻址</strong>」的文件系统来存储磁盘上所有的文件。</p> <p>基于内容寻址是一种文件系统的设计原则，<strong>以文件内容的哈希值作为文件的唯一标识符</strong>，并将文件存储在以哈希值命名的目录中。这样的设计使得相同内容的文件只会存储一次，避免了重复存储相同文件的问题。</p> <blockquote><p>在 <code>pnpm</code> 的 <code>store</code> 目录中，每个文件的名称都是其内容的哈希值，因此同一个文件无论在多个项目中使用，都只会被存储一次。当安装或更新依赖项时，pnpm 会检查 store 目录中是否已经存在所需的文件，如果存在则直接复用，避免了重复的下载和存储。</p></blockquote> <h2 id="nodejs原理详解"><a href="#nodejs原理详解" class="header-anchor">#</a> NodeJs原理详解</h2> <h3 id="进程-process"><a href="#进程-process" class="header-anchor">#</a> 进程(process)</h3> <p>进程Process是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础，进程是线程的容器。进程是资源分配的最小单位。</p> <blockquote><p>Node.js 里通过 <code>node app.js</code> 开启一个服务进程，多进程就是进程的复制（fork），fork 出来的每个进程都拥有自己的独立空间地址、数据栈，一个进程无法访问另外一个进程里定义的变量、数据结构，只有建立了 IPC 通信，进程之间才可数据共享。</p></blockquote> <blockquote><p>chrome浏览器，一个应用，一个运行的js文件，都是一个进程~</p></blockquote> <h3 id="process模块"><a href="#process模块" class="header-anchor">#</a> process模块</h3> <p>Node.js 中的进程 Process 是一个全局对象，无需 require 直接使用，给我们提供了当前进程中的相关信息。</p> <ul><li><code>process.env</code>：环境变量，例如通过  process.env.NODE_ENV 获取不同环境项目配置信息</li> <li><code>process.nextTick</code>：这个在谈及 Event Loop 时经常为会提到</li> <li><code>process.pid</code>：获取当前进程id</li> <li><code>process.cwd()</code>：获取当前进程工作目录，</li> <li><code>process.platform</code>：获取当前进程运行的操作系统平台</li> <li>进程事件：<code>process.on(‘uncaughtException’, cb)</code> 捕获异常信息、<code>process.on(‘exit’, cb</code> 进程退出监听</li> <li><code>process.title</code> 指定进程名称，有的时候需要给进程指定一个名称</li></ul> <h3 id="child-process子进程"><a href="#child-process子进程" class="header-anchor">#</a> child_process子进程</h3> <ul><li>使用 <code>spawn()</code> 方法可以创建一个新的子进程，执行指定的命令。<code>spwan</code>返回的对象上载有流对象,分别是<code>stdout</code>和<code>stderr</code>,这两个对象可以监听数据流.</li></ul> <p><code>child_process.spawn(command[, args][, options])</code></p> <ul><li><code>exec()</code> 方法用于执行一个命令，并返回输出结果和错误。</li></ul> <p><code>child_process.exec(command[, options][, callback])</code></p> <ul><li><code>execFile()</code> 方法用于执行一个可执行文件，类似于 <code>spawn()</code>，但不会创建一个新的 <code>shell</code></li></ul> <p><code>child_process.execFile(file[, args][, options][, callback])</code></p> <ul><li><code>fork()</code> 方法是用于创建一个新的 Node.js 子进程，该子进程执行指定的模块。</li></ul> <blockquote><p>与 spawn() 不同，fork() 只需要指定要执行的模块，不需要指定命令和参数。</p></blockquote> <p><code>child_process.fork(modulePath[, args][, options])</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// child_index.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====进程id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">// child.js</span>
<span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 1. spawn() 方法</span>
<span class="token comment">// 使用 spawn() 方法可以创建一个新的子进程</span>
<span class="token keyword">const</span> workerProcess <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'child_index.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听 child_index.js 的输出</span>
workerProcess<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'spawn cmd data :'</span><span class="token operator">+</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// spawn cmd data :====进程id</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 监听 child_index.js 的错误输出</span>
workerProcess<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'spawn cmd error data :'</span><span class="token operator">+</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 监听 child_index.js 的关闭</span>
workerProcess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'spawn cmd close :'</span><span class="token operator">+</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// spawn cmd close :0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// workerProcess.kill() // 杀死子进程</span>
<span class="token comment">// kill -9 pid</span>


<span class="token comment">// 2. exec() 方法</span>
<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token string">'ls -l'</span><span class="token punctuation">;</span> <span class="token comment">// 要执行的shell命令</span>
<span class="token comment">// 使用 exec() 方法可以创建一个新的子进程</span>
child_process<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>stdout<span class="token punctuation">,</span>stderr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'exec cmd error :'</span><span class="token operator">+</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'exec cmd data :'</span><span class="token operator">+</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 3. execFile() 方法</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">execFile</span><span class="token punctuation">(</span><span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'child_index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'execFile cmd error :'</span><span class="token operator">+</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'execFile cmd data :'</span><span class="token operator">+</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">// 4. fork() 方法</span>
<span class="token comment">// 使用 fork() 方法可以创建一个新的子进程</span>
<span class="token keyword">const</span> fork_child <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'child_index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听子进程的消息事件</span>
fork_child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到子进程消息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 向子进程发送消息</span>
fork_child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello from parent process!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="cluster多进程"><a href="#cluster多进程" class="header-anchor">#</a> cluster多进程</h3> <blockquote><p>web服务器：暴露3000端口  希望有多个进程处理3000端口</p></blockquote> <p>负载均衡load balancer</p> <p>应用部署到多核服务器时，为了充分利用多核 <code>CPU</code> 资源一般启动多个 NodeJS 进程提供服务，这时就会使用到 NodeJS 内置的 <code>Cluster</code> 模块了。Cluster模块可以创建同时运行的子进程（Worker进程），同时共享同一个端口。每个子进程都有自己的事件循环、内存和V8实例。</p> <p>NodeJS Cluster是基于Master-Worker模型的，Master负责监控Worker的状态并分配工作任务，Worker则负责执行具体的任务。Master和Worker之间通过IPC（进程间通信）传递消息，<strong>进程之间没有共享内存</strong>。</p> <blockquote><p>事实上，cluster 模块就是将 <code>child_process</code> 和 <code>net</code> 模块的API组合起来实现的。cluster启动时，进程会在内部启动TCP服务器。而在调用 <code>cluster.fork()</code> 复制子进程时，会将这个TCP服务器端 Socket 的句柄发送给工作进程。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 当前系统有多少个cpu核</span>
<span class="token keyword">const</span> process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 默认是主进程</span>
  <span class="token comment">//处理主进程逻辑</span>
  <span class="token function">masterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//处理子进程逻辑</span>
  <span class="token function">childProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">masterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Master </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is running</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Forking for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>numCPUs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> CPUs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 根据cpu核数创建子进程</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">childProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  http
    <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 创建http服务</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1e7</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 1e7 = 1 * 10^7 = 10000000</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Handling request from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8977</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Started </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
node cluster.js           
Master 27948 is running
Forking for 8 CPUs
Started 27951
Started 27950
Started 27949
Started 27952
Started 27954
Started 27953
Started 27955
Started 27956
 */</span>


<span class="token comment">// 模拟多并发的情况：</span>
<span class="token comment">/**
➜  test-code curl http://127.0.0.1:8977
Hello from 27951
➜  test-code curl http://127.0.0.1:8977
Hello from 27950
➜  test-code curl http://127.0.0.1:8977
Hello from 27949
➜  test-code curl http://127.0.0.1:8977
Hello from 27952
➜  test-code curl http://127.0.0.1:8977
Hello from 27953
➜  test-code curl http://127.0.0.1:8977
Hello from 27954
 */</span>

<span class="token comment">// 多个不同的进程在处理请求，这样就可以提高系统的吞吐量，提高系统的性能。</span>

</code></pre></div><blockquote><p>无论是 child_process 模块还是 cluster 模块，为了解决 Node.js 实例单线程运行，无法利用多核 CPU 的问题而出现的。核心就是父进程（即 master 进程）负责监听端口，接收到新的请求后将其分发给下面的 worker 进程。</p></blockquote> <h3 id="进程间的通信"><a href="#进程间的通信" class="header-anchor">#</a> 进程间的通信</h3> <p>IPC, Inter Process Communication</p> <ul><li>主进程与子进程间的通信：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

process<span class="token punctuation">.</span>title<span class="token operator">=</span><span class="token string">'Nodejs进程 from Zhou'</span><span class="token punctuation">;</span>

<span class="token comment">// 主进程代码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">主进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 正在运行</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建子进程</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Forking for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>numCPUs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> CPUs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 监听子进程的退出事件</span>
  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已退出</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在主进程中监听来自子进程的消息</span>
  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">主进程收到来自子进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 的消息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 向所有子进程发送消息</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> cluster<span class="token punctuation">.</span>workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span>workers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello from master process!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 子进程代码</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 正在运行</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 监听来自主进程的消息</span>
  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 收到消息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 向主进程发送消息</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello from child process: '</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建一个简单的 HTTP 服务器以演示子进程的工作</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, I am a child process! from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8793</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用cluster进行优雅的重启"><a href="#使用cluster进行优雅的重启" class="header-anchor">#</a> 使用Cluster进行优雅的重启</h3> <blockquote><p>当我们更新代码的时候，可能需要重新启动NodeJS。重新启动应用程序时，会出现一个小的空窗期：在我们重启单进程的NodeJS过程中，服务器会无法处理用户的请求</p></blockquote> <p>使用Cluster可以解决这个问题，具体做法如下：一次重新启动一个Worker，剩下的Worker可以继续运行处理用户的请求。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:os&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 当前系统有多少个cpu核</span>
<span class="token keyword">const</span> process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 默认是主进程</span>
  <span class="token comment">//处理主进程逻辑</span>
  <span class="token function">masterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//处理子进程逻辑</span>
  <span class="token function">childProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">// 主进程管理子进程</span>
<span class="token keyword">function</span> <span class="token function">masterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Master </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is running</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// fork 子进程</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Forking for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>numCPUs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> CPUs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> worker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// </span>
    process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;SIGUSR2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

      <span class="token function">restartWorker</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重启子进程</span>

      <span class="token keyword">function</span> <span class="token function">restartWorker</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> workers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> worker <span class="token operator">=</span> workers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Stopping worker: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        worker<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//监听子进程的退出事件</span>
        worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//判断子进程是否完成disconnect过程并正常退出</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>worker<span class="token punctuation">.</span>exitedAfterDisconnect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> newWorker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fork新的子进程</span>
          newWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;listening&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//当新的子进程开始监听端口</span>
            <span class="token comment">//重启下一个子进程</span>
            <span class="token function">restartWorker</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">childProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Worker :&gt;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;hello world\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8756</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="进程守护pm2"><a href="#进程守护pm2" class="header-anchor">#</a> 进程守护PM2</h3> <p><a href="https://pm2.keymetrics.io/" target="_blank" rel="noopener noreferrer">https://pm2.keymetrics.io/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p><code>pm2 stop Name/processID</code> 停止某个服务，通过服务名称或者服务进程ID</p></li> <li><p><code>pm2 delete Name/processID</code> 删除某个服务，通过服务名称或者服务进程ID</p></li> <li><p><code>pm2 logs [Name]</code> 查看日志，如果添加服务名称，则指定查看某个服务的日志，不加则查看所有日志</p></li> <li><p><code>pm2 start app.js -i 4</code> 集群，-i 参数用来告诉PM2以<code>cluster_mode</code>的形式运行你的app（对应的叫fork_mode），后面的数字表示要启动的工作线程的数量。</p></li></ul> <blockquote><p>如果给定的数字为<code>0</code>，PM2则会根据你CPU核心的数量来生成对应的工作线程。注意一般在生产环境使用cluster_mode模式，测试或者本地环境一般使用fork模式，方便测试到错误。</p></blockquote> <ul><li><p><code>pm2 reload Name pm2 restart Name</code> 应用程序代码有更新，可以用重载来加载新代码，也可以用重启来完成,reload可以做到0秒宕机加载新的代码，restart则是重新启动，生产环境中多用reload来完成代码更新！</p></li> <li><p><code>pm2 list</code> 查看pm2中所有项目</p></li> <li><p><code>pm2 monit</code> 用monit可以打开实时监视器去查看资源占用情况</p></li></ul> <h3 id="线程-thread"><a href="#线程-thread" class="header-anchor">#</a> 线程(thread)</h3> <blockquote><p>线程是操作系统能够进行运算调度的最小单位，首先我们要清楚线程是隶属于进程的，被包含于进程之中。<strong>一个线程只能隶属于一个进程，但是一个进程是可以拥有多个线程的</strong>。  -- 通用描述</p></blockquote> <p><strong>单线程就是一个进程只开一个线程。</strong>  -- NodeJS</p> <p><em>Q: Node.js 到底是单线程的还是多线程的？</em></p> <blockquote><p>基础回答：Node.js 是单线程的。</p></blockquote> <blockquote><p>展开说说：Node.js 在用户代码层面是单线程的。</p></blockquote> <blockquote><p>再严谨一些：Node.js 在 <code>worker_threads</code> 模块出来之前，在用户层面是单线程的。</p></blockquote> <h4 id="worker-thread多线程"><a href="#worker-thread多线程" class="header-anchor">#</a> worker_thread多线程</h4> <blockquote><p>允许在一个 Node.js 实例中运行多个应用程序线程。相比创建多个进程更轻量，并且可以共享内存。进程间通过传输 ArrayBuffer 实例或共享 SharedArrayBuffer 实例来做到这一点。</p></blockquote> <p>worker_threads已被证明是充分利用CPU性能的最佳解决方案：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Worker<span class="token punctuation">,</span> isMainThread<span class="token punctuation">,</span> parentPort<span class="token punctuation">,</span> workerData<span class="token punctuation">,</span> MessageChannel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'worker_threads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是主线程'</span><span class="token punctuation">,</span> isMainThread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 我是主线程 true</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./n.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我不是主线程'</span><span class="token punctuation">,</span> isMainThread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 我不是主线程 false</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>例子：worker_threads 运算斐波那契数列:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// 子线程 worker.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>parentPort<span class="token punctuation">,</span> workerData<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;worker_threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 接收主线程传递的参数 workerData</span>
<span class="token comment">// 同时将计算结果通过 postMessage 发送给主线程</span>
parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token function">getFibonacciNumber</span><span class="token punctuation">(</span>workerData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// 通过子线程执行斐波那契的递归函数</span>
<span class="token keyword">function</span> <span class="token function">getFibonacciNumber</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getFibonacciNumber</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getFibonacciNumber</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">// threads.js</span>

<span class="token comment">// 主线程</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Worker<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;worker_threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>

<span class="token comment">// 创建子线程, 执行worker.js, 并传入参数</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;./worker.js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">workerData</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">num</span><span class="token operator">:</span> number<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

worker<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">th Fibonacci Result: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token parameter">exitCode</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">It exited with code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exitCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Execution in main thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>





<span class="token comment">/**
node threads.js
Execution in main thread
30th Fibonacci Result: 832040
It exited with code 0
 */</span>
</code></pre></div><h4 id="多进程-vs-多线程"><a href="#多进程-vs-多线程" class="header-anchor">#</a> 多进程 vs 多线程</h4> <table><thead><tr><th>属性</th> <th>多进程</th> <th>多线程</th> <th>比较</th></tr></thead> <tbody><tr><td>数据</td> <td>数据共享复杂，需要用IPC；数据是分开的，同步简单</td> <td>因为共享进程数据，数据共享简单，同步复杂</td> <td>各有千秋</td></tr> <tr><td>CPU、内存</td> <td>占用内存多，切换复杂，CPU利用率低</td> <td>占用内存少，切换简单，CPU利用率高</td> <td>多线程更好</td></tr> <tr><td>销毁、切换</td> <td>创建销毁、切换复杂，速度慢</td> <td>创建销毁、切换简单，速度很快</td> <td>多线程更好</td></tr> <tr><td>coding</td> <td>编码简单、调试方便</td> <td>编码、调试复杂</td> <td>编码、调试复杂</td></tr> <tr><td>可靠性</td> <td>进程独立运行，不会相互影响</td> <td>线程同呼吸共命运</td> <td>多进程更好</td></tr> <tr><td>分布式</td> <td>可用于多机多核分布式，易于扩展</td> <td>只能用于多核分布式</td> <td>多进程更好</td></tr></tbody></table> <h3 id="global模块"><a href="#global模块" class="header-anchor">#</a> global模块</h3> <ol><li><code>console.log()</code> 打印</li> <li><code>setTimeout</code> 和<code>setInterval</code> ，延时器和定时器</li> <li><code>__dirname</code> 当前文件夹的绝对路径,  <code>path.join(__dirname, 'xxxx.js')</code></li></ol> <h3 id="dns模块"><a href="#dns模块" class="header-anchor">#</a> DNS模块</h3> <ol><li><p><code>dns.getServers</code>: 返回当前正在使用的 ip地址，以字符串数组形式返回</p></li> <li><p><code>dns.lookup</code>: 使用底层系统工具进行域名解析，返回主机名绑定ip</p></li> <li><p><code>dns.reverse</code>: 执行反向域名系统查询，将 IPv4 或 IPv6 地址解析为主机名数组。</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dns <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> servers <span class="token operator">=</span> dns<span class="token punctuation">.</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回当前正在使用的 ip地址，以字符串数组形式返回</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====dns.getServers'</span><span class="token punctuation">,</span> servers<span class="token punctuation">)</span> <span class="token comment">// [ '10.33.176.66', '10.33.176.67' ]</span>


<span class="token comment">// 使用底层系统工具进行域名解析，返回主机名绑定ip地址的数组</span>
dns<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">'www.baidu.com'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">all</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> address</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====dns.lookup err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====dns.lookup'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 执行反向域名系统查询，将 IPv4 或 IPv6 地址解析为主机名数组。</span>
dns<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token string">'123.57.172.182'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> hostname</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====dns.reverse err'</span><span class="token punctuation">,</span>  err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'====dns.reverse'</span><span class="token punctuation">,</span> hostname<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="fs模块"><a href="#fs模块" class="header-anchor">#</a> fs模块</h3> <p>Node.js 的文件系统模块是靠 libuv 提供的，而 libuv 在 Linux 之类的操作系统中，则是封装了系统提供的那些 API。层层套娃，在 Node.js 的 JavaScript 侧又多套了几层，最终到达了现在的样子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//参数1： 文件的路径</span>
<span class="token comment">//参数2(可选)： 编码，如果设置了，返回一个字符串，如果没有设置，会返回一个buffer对象</span>
<span class="token comment">//参数3： 回调函数</span>
<span class="token comment">// readFile不会阻塞，readFileAsync 会阻塞</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取文件失败'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取文件成功'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">//参数1：文件的路径(如果文件不存在，会自动创建)</span>
<span class="token comment">//参数2：写入的文件内容（注意：写入的内容会覆盖以前的内容）</span>
<span class="token comment">//参数3：写文件后的回调函数</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'2.txt'</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入文件失败'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入文件成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">//参数1：文件的路径(如果文件不存在，会自动创建)</span>
<span class="token comment">//参数2：追加的文件内容（注意：写入的内容会覆盖以前的内容）</span>
<span class="token comment">//参数3：追加文件后的回调函数</span>
fs<span class="token punctuation">.</span><span class="token function">appendFile</span><span class="token punctuation">(</span><span class="token string">'2.txt'</span><span class="token punctuation">,</span> <span class="token string">'我是追加的内容'</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'追加文件内容失败'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'追加文件内容成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="buffer-与stream"><a href="#buffer-与stream" class="header-anchor">#</a> Buffer 与Stream</h3> <ul><li><strong>Buffer</strong>是数据以二进制形式临时存放在内存中的物理映射，stream为搬运数据的传送带和加工器，有方向、状态、缓冲大小。</li></ul> <ol><li>Buffer =&gt; utf8：如遇到非UTF-8数据会转换为 �。</li> <li>Buffer =&gt; utf16le：每个字符会使用2或4个字节进行编码。</li> <li>Buffer =&gt; latin1：指定了Unicode编码范围，超出会截断并映射为范围内的字符串。</li></ol> <ul><li>**流（stream）**是 Node.js 中处理流式数据的抽象接口。 stream 模块用于构建实现了流接口的对象。 Node.js 提供了多种流对象。 例如，HTTP 服务器的请求和 <code>process.stdout</code> 都是流的实例。</li></ul> <h3 id="path模块"><a href="#path模块" class="header-anchor">#</a> Path模块</h3> <p>使用 path.join() 方法，可以把多个路径片段拼接为完整的路径字符串，语法格式如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可以把多个路径片段拼接为完整的路径字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'成绩.txt'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>


<span class="token comment">// 使用 path.basename() 方法，获取到文件的名称(有无扩展名，与路径本身有无扩展名一致)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// index.html</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'a/b/c/index.html'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// index.html</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/a.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// a.jpg</span>


<span class="token comment">//  path.extname() 方法，可以获取路径中的扩展名部分，语法格式如下：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'a/b/c/index.html'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// .html</span>

</code></pre></div><h3 id="http模块"><a href="#http模块" class="header-anchor">#</a> http模块</h3> <p>http 模块是 Node.js 官方提供的、用来创建web 服务器的模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.引入http模块</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.创建服务器</span>
<span class="token keyword">const</span> server<span class="token operator">=</span>http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 3.启动服务并监听</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你来辣'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 4.监听用户的请求</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 设置字符集为utf-8(让中文能被解析),写在第一行</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span><span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'莫西莫西'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(req.headers);</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 请求的方式</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 请求的地址</span>

    <span class="token comment">// res.statusCode=404  // 设置状态码</span>
    <span class="token comment">// res.statusMessage='not find'  // 设置状态信息</span>
        <span class="token comment">// res.write('abc')</span>
    <span class="token comment">// res.end写在最后</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1&gt;牛&lt;/h1&gt;'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="os模块"><a href="#os模块" class="header-anchor">#</a> os模块</h3> <ul><li>networkInterfaces获取网络信息</li> <li>cpus：获取系统的CPU内核细腻，返回个数组</li> <li>totalmem：系统总共内存容量</li> <li>freemem：系统空余内存变量</li> <li>hostname：系统主机名</li> <li>version: 系统内核版本的字符串</li> <li>platform: 主机操作系统平摊</li> <li>type: 主机的操作系统平台名称,可能的值为'aix'、'darwin'、'freebsd'、'linux'、'openbsd'、'sunos'、以及 'win32'。</li> <li>uptime: 操作系统正常运行时间</li></ul> <h2 id="express-js"><a href="#express-js" class="header-anchor">#</a> Express.js</h2> <p><a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">Express<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个基于Node平台的web应用开发框架</p> <p>Express框架的核心是 <strong>中间件</strong></p> <p><a href="https://expressjs.com/en/starter/generator.html" target="_blank" rel="noopener noreferrer">ExpressJS  helloworld<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <ul><li><p>cors</p></li> <li><p>express-session</p></li> <li><p>express-jwt &amp; jsonwebtoken</p></li> <li><p>Swagger</p></li></ul> <h3 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h3> <blockquote><p>在Web应用发展的初期，那时关系型数据库受到了较为广泛的关注和应用，原因是因为那时候Web站点基本上访问和并发不高、交互也较少。而在后来，随着访问量的提升，使用关系型数据库的Web站点多多少少都开始在性能上出现了一些瓶颈。</p></blockquote> <p>而随着互联网技术的进一步发展，各种类型的应用层出不穷，这导致在当今云计算、大数据盛行的时代，对性能有了更多的需求，主要体现在以下四个方面：</p> <ol><li>低延迟的读写速度：应用快速地反应能极大地提升用户的满意度</li> <li>支撑海量的数据和流量：对于搜索这样大型应用而言，需要利用PB级别的数据和能应对百万级的流量</li> <li>大规模集群的管理：系统管理员希望分布式应用能更简单的部署和管理</li> <li>庞大运营成本的考量：IT部门希望在硬件成本、软件成本和人力成本能够有大幅度地降低</li></ol> <h4 id="sql"><a href="#sql" class="header-anchor">#</a> SQL</h4> <blockquote><p>SQL数据库是一个使用结构化查询语言（SQL）来存储、检索和操作数据的关系数据库。它有资格作为一种编程语言。SQL数据库是最常见的<strong>关系数据库类型</strong>，它们被各种各样的企业和组织所使用。</p></blockquote> <ul><li>MySQL    =&gt;  <code>SELECT * FROM xxTable JOIN TyTable on xxTable.xx = TyTable.yy WHERE xx = xxx ORDER by xxx</code></li> <li>PostgreSQL  =&gt;</li> <li>TypeORM</li></ul> <h3 id="nosql"><a href="#nosql" class="header-anchor">#</a> NoSQL</h3> <blockquote><p>同时具备了高性能、可扩展性强、高可用等优点~</p></blockquote> <ul><li>Redis</li></ul> <blockquote><p>Redis是现在最受欢迎的NoSQL数据库之一，Redis是一个使用ANSI C编写的开源、包含多种数据结构、支持网络、基于内存、可选持久性的键值对存储数据库。</p></blockquote> <ul><li>MongoDB  =&gt;  JSON</li></ul> <blockquote><p>MongoDB 是非关系型的数据库（NoSQL)，属于文档型数据库，文档数据库就是为了解决关系数据库带来的问题。最大的特点是 <code>no-schema</code>，可以存储和读取任意的数据。</p></blockquote> <blockquote><p>存储的数据格式就是 JSON（或者 BSON）。JSON 格式我们都比较熟悉，比如 Rest API 请求返回的 Response 就是 JSON 格式的。JSON 格式的数据和 XML 个格式的区别是 JSON 更简单，没有那么多的标签来定义字段名。也就是说 JSON 是自描述的。另外 JSON 格式存进 MongoDB 中后，即使读取一个 JSON 中不存在的字段也不会导致 SQL 那样的语法错误。</p></blockquote> <ul><li>Mongoose  =&gt;  ODM</li></ul> <blockquote><p>Mongoose 是一个用于Node.js的对象模型工具，用于在Node.js应用程序中与MongoDB数据库进行交互。它是一个MongoDB的ODM（对象文档映射器），允许你在应用程序中定义数据模型、验证数据、执行查询以及与MongoDB数据库进行交互，而无需直接使用MongoDB的原始驱动程序。</p></blockquote> <ul><li>如何写一个ExpressJS中间件？</li></ul> <blockquote><p>展示了如何编写一个简单的 Express.js 中间件，它记录每个请求的时间戳：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入 Express.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义中间件函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">logTimestamp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] - Request received for: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 next() 以继续请求处理链</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 将中间件函数绑定到应用程序</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 路由处理</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello, Express!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 启动 Express.js 应用程序</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server is running on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="基于expressjs实现登录鉴权"><a href="#基于expressjs实现登录鉴权" class="header-anchor">#</a> 基于ExpressJS实现登录鉴权</h3> <p>登录态方案：JWT与Session</p> <p><strong>登录状态的保存</strong>问题的解决有两种方案：</p> <ul><li>服务端存储的 session + cookie 的方案</li></ul> <blockquote><p>session + cookie 的给 http 添加状态的方案是服务端保存 session 数据，然后把 id 放入 cookie 返回，cookie 是自动携带的，每个请求可以通过 cookie 里的 id 查找到对应的 session，从而实现请求的标识。这种方案能实现需求，但是有 CSRF、分布式 session、跨域等问题，不过都是有解决方案的。</p></blockquote> <ul><li>客户端存储的 jwt token 的方案</li></ul> <blockquote><p>token 的方案常用 json 格式来保存，叫做 json web token，简称 JWT。</p></blockquote> <p>JWT 是保存在 request header 里的一段字符串（比如用 header 名可以叫 authorization），它分为三部分：<code>header、payload、verify signature</code></p> <ul><li>header 部分保存当前的加密算法</li> <li>payload 部分是具体存储的数据</li> <li>verify signature 部分是把 header 和 payload 还有 salt 做一次加密之后生成的。（salt，盐，就是一段任意的字符串，增加随机性）</li></ul> <p>这三部分会分别做 Base64，然后连在一起就是 JWT 的 header，放到某个 header 比如 authorization 中：</p> <p><code>authorization: Bearer xxxxx.xxxxx.xxxx</code></p> <p>请求的时候把这个 header 带上，服务端就可以解析出对应的 header、payload、verify signature 这三部分，然后根据 header 里的算法也对 header、payload 加上 salt 做一次解密，如果得出的结果和 verify signature 一样，就接受这个 token。</p> <blockquote><p>把状态数据都保存在 payload 部分，这样就实现了有状态的 http~</p></blockquote> <p>JWT 的方案是把状态数据保存在 header 里，每次请求需要手动携带，没有 session + cookie 方案的 CSRF、分布式、跨域的问题，但是也有安全性、性能、没法控制等问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//express-session</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> secretKey <span class="token operator">=</span> <span class="token string">'your-secret-key'</span><span class="token punctuation">;</span> <span class="token comment">// 用于签名和验证JWT令牌的密钥</span>

<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 用于模拟用户数据</span>

<span class="token comment">// 用户注册</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实际应用中应该存储到数据库并进行密码哈希</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'User registered successfully'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 用户登录</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> u<span class="token punctuation">.</span>username <span class="token operator">===</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> user<span class="token punctuation">.</span>password <span class="token operator">!==</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid credentials'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Authorazion:  Bear Token</span>

<span class="token comment">// 生成JWT令牌</span>
<span class="token keyword">function</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token parameter">username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secretKey<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">'1h'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 保护路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/protected-route'</span><span class="token punctuation">,</span> verifyToken<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// JWT令牌验证中间件</span>
<span class="token keyword">function</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Access denied'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>user <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server is running on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="koa"><a href="#koa" class="header-anchor">#</a> Koa</h2> <p><a href="https://koajs.com/" target="_blank" rel="noopener noreferrer">https://koajs.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Koa 是 Express 的轻量级版本。它是一个中间件框架，没有像 Express 那样的额外模块（比如，没有内置路由和模板引擎）。Koa 由与 Express 相同的团队开发。事实上，许多人认为 Koa 是“Express 5.0”，因为它的开发很大程度上是最初 Express 的所有权问题导致。</p> <p>洋葱模型</p> <h3 id="koa与express的区别"><a href="#koa与express的区别" class="header-anchor">#</a> Koa与Express的区别</h3> <ol><li>中间件链接方式</li></ol> <blockquote><p>Express 中间件链是基于回调的，而 Koa 的则是基于 Promise 的。这就是为什么我们在 Express 中最后定义 errorMiddleware，在 Koa 中首先定义 handleError。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware3<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">// koa</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 中间件1</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 1 - Before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 5</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 1 - After'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 中间件2</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// 2</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 2 - Before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4 </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 2 - After'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 路由处理程序</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//3</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Route Handler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server is running on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>增强 Node vs 替换 Node</li></ol> <ul><li>Express 是 NodeJS 的一个 Web 框架。它通过为 Node 的 req 和 res 对象添加有用的方法和属性来增强其功能。</li></ul> <blockquote><p>例如，Express 会向 http req 对象添加像 req.method 和 req.headers() 这样的内容，并向 http res 对象添加 res.sendFile()。</p></blockquote> <ul><li>Koa 是 NodeJS 的一个中间件框架。Koa 使用自己的上下文（ctx）替换或提取 Node 的 req 和 res 对象属性。</li></ul> <blockquote><p>例如，<code>context.body = result</code> 可以为请求设置响应体。</p></blockquote> <ol start="3"><li>更加轻量
Koa 比 Express 更轻量级。Koa 不像 Express 那样包含路由器或视图引擎模块。这些模块是单独存在的，可以很容易地被包含进来。在我们的示例中，你会注意到我们必须为 Koa 实例单独包含 koa-router，而Express 中已经内置这个功能。</li></ol> <h3 id="next-js"><a href="#next-js" class="header-anchor">#</a> Next.js</h3> <p>React 服务端渲染应用框架</p> <p>SSR: 利于爬虫，seo优化</p> <p><a href="https://nextjs.org/docs" target="_blank" rel="noopener noreferrer">https://nextjs.org/docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="nestjs"><a href="#nestjs" class="header-anchor">#</a> NestJs</h2> <blockquote></blockquote> <p>Nest (NestJS) 是一个用于构建高效、可扩展的 Node.js 服务器端应用的框架。 它使用渐进式 JavaScript，构建并完全支持 TypeScript（但仍然允许开发者使用纯 JavaScript 进行编码）并结合了 OOP（面向对象编程）、FP（函数式编程）和 FRP（函数式反应式编程）的元素。</p> <p>企业级服务端架构</p> <p>用 Node 写一个 http 服务有三个层次：</p> <ul><li>直接使用 http、https 的模块    http.createServer((req, res) =&gt; {  if(req.method === 'GET')  })</li> <li>使用 express、koa 这种库</li> <li>使用 Nest 这种企业级框架  /  EggJS</li></ul> <p><a href="https://nest.nodejs.cn/" target="_blank" rel="noopener noreferrer">https://nest.nodejs.cn/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h3> <p><strong>MVC</strong> 是 Model View Controller 的简写。MVC 架构下，请求会先发送给 Controller，由它调度 Model 层的 Service 来完成业务逻辑，然后返回对应的 View。</p> <blockquote><p>后端框架基本都是 MVC 的架构。</p></blockquote> <p>Nest 提供了 AOP （Aspect Oriented Programming）的能力，也就是面向切面编程的能力。</p> <h3 id="装饰器语法"><a href="#装饰器语法" class="header-anchor">#</a> 装饰器语法</h3> <p>装饰器在 TypeScript 等语言中被广泛使用，但是 JavaScript 装饰器的支持仍处于第 2 阶段提案中。但是，我们可以借助 Babel 和 TypeScript 编译器使用 JavaScript 装饰器。</p> <p>类装饰器， 概念类似HOC</p> <p>TS装饰器：</p> <ol><li>类装饰器</li> <li>函数装饰器</li> <li>属性装饰器</li> <li>参数装饰器</li></ol> <h3 id="nest与express的关系"><a href="#nest与express的关系" class="header-anchor">#</a> Nest与Express的关系</h3> <p>Express 只是一个处理请求的库，并没有提供组织代码的架构能力，代码可能写成各种样子。</p> <p>所以企业级开发，我们会用对它封装了一层的库，比如 Nest。</p> <p>Nest 提供了 IOC、AOP 等架构特性，规定了代码组织的形式，而且对 websocket、graphql、orm 等各种方案都提供了开箱即用的支持。</p> <h3 id="docker"><a href="#docker" class="header-anchor">#</a> Docker</h3> <p>隔离的环境 ，通过docker 配置文件，配置容器内部的运行环境， 通过暴露端口与容器外通信</p> <h3 id="数据库-2"><a href="#数据库-2" class="header-anchor">#</a> 数据库</h3> <ul><li><p>MySQL</p></li> <li><p>NoSQL</p></li></ul> <h3 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h3> <p>做后端服务的时候，我们不会只用 mysql，一般会结合内存数据库来做缓存，最常用的是 redis。</p> <h3 id="例-实现扫码登录系统"><a href="#例-实现扫码登录系统" class="header-anchor">#</a> 例：实现扫码登录系统</h3> <ul><li>二维码状态</li></ul> <ol><li>未扫描</li> <li>已扫描，等待用户确认</li> <li>已扫描，用户同意授权</li> <li>已扫描，用户取消授权</li> <li>已过期</li></ol> <div class="custom-block tip"><p class="custom-block-title">实现思路</p> <ul><li>首先PC端会有一个二维码展示页面：</li></ul> <ol><li>服务端有个 <code>qrcode/generate</code> 接口，会生成一个随机的二维码 id，生成二维码确认页面url, 同时将该url生成一个二维码；</li> <li>还有个 <code>qrcode/check</code> 接口，会返回该二维码id的二维码状态，浏览器里可以轮询这个接口拿到二维码状态；</li></ol> <ul><li>然后手机 APP 扫码，如果没登录，会先跳转到登录页面，登录之后会进入登录确认页面:</li></ul> <ol start="3"><li>进入确认页后首先从url中拿到了二维码id，然后调用 <code>qrcode/scan</code>接口切换二维码状态为【已扫描，等待用户确认】，PC展示页通过轮询也会及时更新状态；</li> <li>之后 如果点击取消则调取消接口：<code>qrcode/cancel</code>，点击确认则确认接口：<code>qrcode/confirm</code>, 可修改二维码为不同的状态；在调确认接口时，客户端会传用户token, 服务端拿到token校验用户是否信息，返回是否校验通过信息；</li> <li>PC端轮询拿到状态后就可以进行后续处理了~</li></ol></div> <h2 id="备注"><a href="#备注" class="header-anchor">#</a> 备注</h2> <ul><li><p><strong>如何在Linux中操作进程</strong></p></li> <li><p>查找与进程相关的PID号 <code>ps aux | grep xx</code></p> <ul><li>Ps: <code>process status</code></li> <li>Aux
<ul><li>A:   all 所有进程</li> <li>U：user</li> <li>X：显示后台进程和守护进程</li></ul></li> <li>| ：管道符号</li> <li>grep： 查找  字符串/正则</li></ul></li> <li><p>终止进程 <code>kill -9 pid</code></p></li></ul> <h2 id="收藏"><a href="#收藏" class="header-anchor">#</a> 收藏</h2> <ul><li><p><a href="https://vzx6t9oio6.feishu.cn/docx/BZfrdIBHWo7J9PxEfNBccKARnwf" target="_blank" rel="noopener noreferrer">0903 - Nodejs：全栈基石 - 讲义<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://getbyteoffer.feishu.cn/docx/IAHYdupFVoHTwOxXdOBcFbnonLe" target="_blank" rel="noopener noreferrer">Backend - NodeJS <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://survey.stackoverflow.co/2023/#most-popular-technologies-language-other" target="_blank" rel="noopener noreferrer">https://survey.stackoverflow.co/2023/#most-popular-technologies-language-other<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/6/2023, 11:12:18 PM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list no-article-list"><div class="article-title"><a href="/blog/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/more/node-deploy.html"><div>
            Vue+Node实现可视化部署工具
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/tool/vscode-plugins.html"><div>
            VSCode插件开发笔记
            <!----></div></a> <span class="date">01-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/skills/vue/vue3-cli-repo.html"><div>
            开发一个快速搭建vue3项目的脚手架
            <!----></div></a> <span class="date">12-13</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2024
    <span>一苇 | <a href="https://beian.miit.gov.cn/" target="_blank" style="font-weight:normal"><img src="/blog/images/icp.png" width="20" height="20" alt="公网备案"/>京ICP备2021006935号-2</a> </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><!----><!----><div></div></div></div>
    <script src="/blog/assets/js/app.76fa57e6.js" defer></script><script src="/blog/assets/js/3.a2a245ac.js" defer></script><script src="/blog/assets/js/210.8af7e1c3.js" defer></script><script src="/blog/assets/js/4.245b4373.js" defer></script>
  </body>
</html>
