<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solidity入门笔记02 | 一苇</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/icons/favicon.ico">
    <link rel="manifest" href="/blog/js/mainfest.json">
    <link rel="stylesheet" href="/blog/styles/css/style.css">
    <script type="utf-8" src="/blog/js/disable-user-zoom.js"></script>
    <meta name="description" content="这是阿沐的博客哦~">
    <meta name="Author" content="一苇">
    <meta rel="keywords" content="verneyzhou,阿沐,一苇,前端,docs.verneyzhou-code.cn,博客,fe,IT,技术">
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta name="viewport" content="width=device-width,width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.61668f40.css" as="style"><link rel="preload" href="/blog/assets/js/app.a61e072d.js" as="script"><link rel="preload" href="/blog/assets/js/3.a2a245ac.js" as="script"><link rel="preload" href="/blog/assets/js/90.44324668.js" as="script"><link rel="preload" href="/blog/assets/js/4.245b4373.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.4c1e4a89.js"><link rel="prefetch" href="/blog/assets/js/100.f77381aa.js"><link rel="prefetch" href="/blog/assets/js/101.42c0eba5.js"><link rel="prefetch" href="/blog/assets/js/102.fc2f390c.js"><link rel="prefetch" href="/blog/assets/js/103.4fc28f66.js"><link rel="prefetch" href="/blog/assets/js/104.b2d43034.js"><link rel="prefetch" href="/blog/assets/js/105.2271cc3a.js"><link rel="prefetch" href="/blog/assets/js/106.8c7d90ba.js"><link rel="prefetch" href="/blog/assets/js/107.a06cf6c1.js"><link rel="prefetch" href="/blog/assets/js/108.3158be20.js"><link rel="prefetch" href="/blog/assets/js/109.0ec38d53.js"><link rel="prefetch" href="/blog/assets/js/11.3616a892.js"><link rel="prefetch" href="/blog/assets/js/110.ca1974a6.js"><link rel="prefetch" href="/blog/assets/js/111.9286d0dd.js"><link rel="prefetch" href="/blog/assets/js/112.f9583ffd.js"><link rel="prefetch" href="/blog/assets/js/113.5dcca596.js"><link rel="prefetch" href="/blog/assets/js/114.c5ee0062.js"><link rel="prefetch" href="/blog/assets/js/115.05f23474.js"><link rel="prefetch" href="/blog/assets/js/116.0da3b639.js"><link rel="prefetch" href="/blog/assets/js/117.4ab482ea.js"><link rel="prefetch" href="/blog/assets/js/118.1368c2af.js"><link rel="prefetch" href="/blog/assets/js/119.67f6baf0.js"><link rel="prefetch" href="/blog/assets/js/12.d9db4c3e.js"><link rel="prefetch" href="/blog/assets/js/120.2bae53c8.js"><link rel="prefetch" href="/blog/assets/js/121.2de5e605.js"><link rel="prefetch" href="/blog/assets/js/122.787b3164.js"><link rel="prefetch" href="/blog/assets/js/123.c1d9b0bf.js"><link rel="prefetch" href="/blog/assets/js/124.d3228779.js"><link rel="prefetch" href="/blog/assets/js/125.0a593e9e.js"><link rel="prefetch" href="/blog/assets/js/126.430054b8.js"><link rel="prefetch" href="/blog/assets/js/127.6243fb46.js"><link rel="prefetch" href="/blog/assets/js/128.b853c8b2.js"><link rel="prefetch" href="/blog/assets/js/129.10805108.js"><link rel="prefetch" href="/blog/assets/js/13.16541f63.js"><link rel="prefetch" href="/blog/assets/js/130.fbf6c629.js"><link rel="prefetch" href="/blog/assets/js/131.e7a1c248.js"><link rel="prefetch" href="/blog/assets/js/132.e4e3e031.js"><link rel="prefetch" href="/blog/assets/js/133.4cffab1f.js"><link rel="prefetch" href="/blog/assets/js/134.5f521e08.js"><link rel="prefetch" href="/blog/assets/js/135.101d35e6.js"><link rel="prefetch" href="/blog/assets/js/136.e885ab88.js"><link rel="prefetch" href="/blog/assets/js/137.89ba0b9a.js"><link rel="prefetch" href="/blog/assets/js/138.b6dc58a6.js"><link rel="prefetch" href="/blog/assets/js/139.796b8dc6.js"><link rel="prefetch" href="/blog/assets/js/14.d7838f6c.js"><link rel="prefetch" href="/blog/assets/js/140.f9d3bca5.js"><link rel="prefetch" href="/blog/assets/js/141.877fdada.js"><link rel="prefetch" href="/blog/assets/js/142.1b30c911.js"><link rel="prefetch" href="/blog/assets/js/143.d5332854.js"><link rel="prefetch" href="/blog/assets/js/144.40bbe403.js"><link rel="prefetch" href="/blog/assets/js/145.61d8f8b1.js"><link rel="prefetch" href="/blog/assets/js/146.8901f554.js"><link rel="prefetch" href="/blog/assets/js/147.ada41a12.js"><link rel="prefetch" href="/blog/assets/js/148.750e3c9a.js"><link rel="prefetch" href="/blog/assets/js/149.100f9f93.js"><link rel="prefetch" href="/blog/assets/js/15.e0f3979f.js"><link rel="prefetch" href="/blog/assets/js/150.9981209a.js"><link rel="prefetch" href="/blog/assets/js/151.036a6210.js"><link rel="prefetch" href="/blog/assets/js/152.71dfb1de.js"><link rel="prefetch" href="/blog/assets/js/153.558f43bd.js"><link rel="prefetch" href="/blog/assets/js/154.17ab6485.js"><link rel="prefetch" href="/blog/assets/js/155.6c606a83.js"><link rel="prefetch" href="/blog/assets/js/156.52df9079.js"><link rel="prefetch" href="/blog/assets/js/157.f36928fb.js"><link rel="prefetch" href="/blog/assets/js/158.30dfbb2b.js"><link rel="prefetch" href="/blog/assets/js/159.622f8050.js"><link rel="prefetch" href="/blog/assets/js/16.976e0a23.js"><link rel="prefetch" href="/blog/assets/js/160.e549dd75.js"><link rel="prefetch" href="/blog/assets/js/161.cf63888a.js"><link rel="prefetch" href="/blog/assets/js/162.4eaf8aa2.js"><link rel="prefetch" href="/blog/assets/js/163.e44c8842.js"><link rel="prefetch" href="/blog/assets/js/164.06073797.js"><link rel="prefetch" href="/blog/assets/js/165.05ea6ac9.js"><link rel="prefetch" href="/blog/assets/js/166.6e08ddcd.js"><link rel="prefetch" href="/blog/assets/js/167.e455115d.js"><link rel="prefetch" href="/blog/assets/js/168.3c3b2be6.js"><link rel="prefetch" href="/blog/assets/js/169.20a98b8d.js"><link rel="prefetch" href="/blog/assets/js/17.6fe7bc77.js"><link rel="prefetch" href="/blog/assets/js/170.c150ba4a.js"><link rel="prefetch" href="/blog/assets/js/171.174a7772.js"><link rel="prefetch" href="/blog/assets/js/172.dd2388e9.js"><link rel="prefetch" href="/blog/assets/js/173.915c16eb.js"><link rel="prefetch" href="/blog/assets/js/174.f0be0558.js"><link rel="prefetch" href="/blog/assets/js/175.adf92661.js"><link rel="prefetch" href="/blog/assets/js/176.3fb637a7.js"><link rel="prefetch" href="/blog/assets/js/177.8c8b7b0a.js"><link rel="prefetch" href="/blog/assets/js/178.53b512f9.js"><link rel="prefetch" href="/blog/assets/js/179.bb720bc9.js"><link rel="prefetch" href="/blog/assets/js/18.57f41416.js"><link rel="prefetch" href="/blog/assets/js/180.579718eb.js"><link rel="prefetch" href="/blog/assets/js/181.24effdb0.js"><link rel="prefetch" href="/blog/assets/js/182.56aec271.js"><link rel="prefetch" href="/blog/assets/js/183.e9279fba.js"><link rel="prefetch" href="/blog/assets/js/184.e2c6cc70.js"><link rel="prefetch" href="/blog/assets/js/185.b5b1a5bd.js"><link rel="prefetch" href="/blog/assets/js/186.a5d37fba.js"><link rel="prefetch" href="/blog/assets/js/187.3c0be269.js"><link rel="prefetch" href="/blog/assets/js/188.65c0dd2e.js"><link rel="prefetch" href="/blog/assets/js/189.ed4b7230.js"><link rel="prefetch" href="/blog/assets/js/19.4facbfcd.js"><link rel="prefetch" href="/blog/assets/js/190.f4c55a9b.js"><link rel="prefetch" href="/blog/assets/js/191.f0af298f.js"><link rel="prefetch" href="/blog/assets/js/192.edea4f13.js"><link rel="prefetch" href="/blog/assets/js/193.46217964.js"><link rel="prefetch" href="/blog/assets/js/194.5f68bdcb.js"><link rel="prefetch" href="/blog/assets/js/195.6dceaaf2.js"><link rel="prefetch" href="/blog/assets/js/196.08f94846.js"><link rel="prefetch" href="/blog/assets/js/197.39b5b311.js"><link rel="prefetch" href="/blog/assets/js/198.f7e557d2.js"><link rel="prefetch" href="/blog/assets/js/199.43335e98.js"><link rel="prefetch" href="/blog/assets/js/20.c69c50ee.js"><link rel="prefetch" href="/blog/assets/js/21.816d2b3e.js"><link rel="prefetch" href="/blog/assets/js/22.6d93bd09.js"><link rel="prefetch" href="/blog/assets/js/23.be1dd041.js"><link rel="prefetch" href="/blog/assets/js/24.07340cbd.js"><link rel="prefetch" href="/blog/assets/js/25.3f3fefdf.js"><link rel="prefetch" href="/blog/assets/js/26.a89769e9.js"><link rel="prefetch" href="/blog/assets/js/27.b6bd428e.js"><link rel="prefetch" href="/blog/assets/js/28.6cebd8e8.js"><link rel="prefetch" href="/blog/assets/js/29.e89de8a1.js"><link rel="prefetch" href="/blog/assets/js/30.8b2c9d5a.js"><link rel="prefetch" href="/blog/assets/js/31.da15266b.js"><link rel="prefetch" href="/blog/assets/js/32.cc2bcb14.js"><link rel="prefetch" href="/blog/assets/js/33.b9478bf1.js"><link rel="prefetch" href="/blog/assets/js/34.c49fa245.js"><link rel="prefetch" href="/blog/assets/js/35.fccd851c.js"><link rel="prefetch" href="/blog/assets/js/36.7a0bbd4c.js"><link rel="prefetch" href="/blog/assets/js/37.977fcc61.js"><link rel="prefetch" href="/blog/assets/js/38.034bf38e.js"><link rel="prefetch" href="/blog/assets/js/39.d0d09946.js"><link rel="prefetch" href="/blog/assets/js/40.3fce48ff.js"><link rel="prefetch" href="/blog/assets/js/41.c13471b6.js"><link rel="prefetch" href="/blog/assets/js/42.6514b43d.js"><link rel="prefetch" href="/blog/assets/js/43.9612412b.js"><link rel="prefetch" href="/blog/assets/js/44.12b59335.js"><link rel="prefetch" href="/blog/assets/js/45.15c03eea.js"><link rel="prefetch" href="/blog/assets/js/46.db7ce530.js"><link rel="prefetch" href="/blog/assets/js/47.39b634bf.js"><link rel="prefetch" href="/blog/assets/js/48.602019b9.js"><link rel="prefetch" href="/blog/assets/js/49.bd5b255d.js"><link rel="prefetch" href="/blog/assets/js/5.03e046a2.js"><link rel="prefetch" href="/blog/assets/js/50.3ca122c2.js"><link rel="prefetch" href="/blog/assets/js/51.c5759db3.js"><link rel="prefetch" href="/blog/assets/js/52.d8cde00f.js"><link rel="prefetch" href="/blog/assets/js/53.5a746850.js"><link rel="prefetch" href="/blog/assets/js/54.a81738d8.js"><link rel="prefetch" href="/blog/assets/js/55.bfb97cf4.js"><link rel="prefetch" href="/blog/assets/js/56.bdffa8b6.js"><link rel="prefetch" href="/blog/assets/js/57.80a6b7e5.js"><link rel="prefetch" href="/blog/assets/js/58.3c5fd95a.js"><link rel="prefetch" href="/blog/assets/js/59.208c9eb8.js"><link rel="prefetch" href="/blog/assets/js/6.9db196de.js"><link rel="prefetch" href="/blog/assets/js/60.f94c0615.js"><link rel="prefetch" href="/blog/assets/js/61.3b7c53e7.js"><link rel="prefetch" href="/blog/assets/js/62.f3cfdb27.js"><link rel="prefetch" href="/blog/assets/js/63.7d893fc9.js"><link rel="prefetch" href="/blog/assets/js/64.f82d1615.js"><link rel="prefetch" href="/blog/assets/js/65.b10bc2e9.js"><link rel="prefetch" href="/blog/assets/js/66.fd0ee3c5.js"><link rel="prefetch" href="/blog/assets/js/67.7d91e23d.js"><link rel="prefetch" href="/blog/assets/js/68.e8279e07.js"><link rel="prefetch" href="/blog/assets/js/69.24de5fc3.js"><link rel="prefetch" href="/blog/assets/js/7.19695e84.js"><link rel="prefetch" href="/blog/assets/js/70.594379e0.js"><link rel="prefetch" href="/blog/assets/js/71.ddf7d07d.js"><link rel="prefetch" href="/blog/assets/js/72.c0092574.js"><link rel="prefetch" href="/blog/assets/js/73.a82ce7ba.js"><link rel="prefetch" href="/blog/assets/js/74.eafc3f3b.js"><link rel="prefetch" href="/blog/assets/js/75.39d52dec.js"><link rel="prefetch" href="/blog/assets/js/76.ca00619d.js"><link rel="prefetch" href="/blog/assets/js/77.57c097f6.js"><link rel="prefetch" href="/blog/assets/js/78.5da92f52.js"><link rel="prefetch" href="/blog/assets/js/79.34f376f9.js"><link rel="prefetch" href="/blog/assets/js/8.a2d18997.js"><link rel="prefetch" href="/blog/assets/js/80.1b290490.js"><link rel="prefetch" href="/blog/assets/js/81.8e0dcacf.js"><link rel="prefetch" href="/blog/assets/js/82.2d89a5d6.js"><link rel="prefetch" href="/blog/assets/js/83.6e11a5e5.js"><link rel="prefetch" href="/blog/assets/js/84.3050aa84.js"><link rel="prefetch" href="/blog/assets/js/85.595de16b.js"><link rel="prefetch" href="/blog/assets/js/86.a38c5af5.js"><link rel="prefetch" href="/blog/assets/js/87.0306e67e.js"><link rel="prefetch" href="/blog/assets/js/88.6b4cd45e.js"><link rel="prefetch" href="/blog/assets/js/89.7fd6c473.js"><link rel="prefetch" href="/blog/assets/js/9.861ea918.js"><link rel="prefetch" href="/blog/assets/js/91.9b2afe5a.js"><link rel="prefetch" href="/blog/assets/js/92.597d8124.js"><link rel="prefetch" href="/blog/assets/js/93.40aefb30.js"><link rel="prefetch" href="/blog/assets/js/94.acae74aa.js"><link rel="prefetch" href="/blog/assets/js/95.2f282ecd.js"><link rel="prefetch" href="/blog/assets/js/96.113f25bc.js"><link rel="prefetch" href="/blog/assets/js/97.5c2bf185.js"><link rel="prefetch" href="/blog/assets/js/98.a1f33a81.js"><link rel="prefetch" href="/blog/assets/js/99.4807bb65.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.381052ad.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.61668f40.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/icons/apple-touch-icon.png" alt="一苇" class="logo"> <span class="site-name can-hide">一苇</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/archives/" class="nav-link">时间轴</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><!----> <span class="title" style="display:;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/js/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/css/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><!----> <span class="title" style="display:;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/skills/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/skills/webpack/" class="nav-link">Webpack</a></li><li class="dropdown-item"><!----> <a href="/blog/code/" class="nav-link">源码</a></li><li class="dropdown-item"><!----> <a href="/blog/more/web3/" class="nav-link router-link-active">Web3</a></li><li class="dropdown-item"><!----> <a href="/blog/more/" class="nav-link router-link-active">更多</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><!----> <span class="title" style="display:;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>PC端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/vue-node-admin/" class="nav-link">vue-node-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-vite-admin.html" class="nav-link">vue3-vite-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-cli-admin.html" class="nav-link">vue3-cli-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-webpack5-admin.html" class="nav-link">vue3-webpack5-admin</a></li><li class="dropdown-subitem"><a href="/blog/project/mono-react-project.html" class="nav-link">teach-react-mono</a></li></ul></li><li class="dropdown-item"><h4>移动端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/mobile-h5/" class="nav-link">微信h5</a></li><li class="dropdown-subitem"><a href="/blog/project/mini-program/" class="nav-link">微信小程序</a></li><li class="dropdown-subitem"><a href="/blog/project/mobile/" class="nav-link">移动端开发笔记</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/tool/" class="nav-link">其他</a></div><div class="nav-item"><a href="https://github.com/verneyZhou" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><!----> <span class="title" style="display:;">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/about/" class="nav-link">ME</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="images/poster03.jpeg"> <div class="blogger-info"><h3></h3> <span>造物钟爱对称。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/archives/" class="nav-link">时间轴</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><!----> <span class="title" style="display:;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/js/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/frontend/css/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><!----> <span class="title" style="display:;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/skills/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/skills/webpack/" class="nav-link">Webpack</a></li><li class="dropdown-item"><!----> <a href="/blog/code/" class="nav-link">源码</a></li><li class="dropdown-item"><!----> <a href="/blog/more/web3/" class="nav-link router-link-active">Web3</a></li><li class="dropdown-item"><!----> <a href="/blog/more/" class="nav-link router-link-active">更多</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><!----> <span class="title" style="display:;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>PC端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/vue-node-admin/" class="nav-link">vue-node-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-vite-admin.html" class="nav-link">vue3-vite-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-cli-admin.html" class="nav-link">vue3-cli-admin</a></li><li class="dropdown-subitem"><a href="/blog/skills/vue/vue3-webpack5-admin.html" class="nav-link">vue3-webpack5-admin</a></li><li class="dropdown-subitem"><a href="/blog/project/mono-react-project.html" class="nav-link">teach-react-mono</a></li></ul></li><li class="dropdown-item"><h4>移动端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/project/mobile-h5/" class="nav-link">微信h5</a></li><li class="dropdown-subitem"><a href="/blog/project/mini-program/" class="nav-link">微信小程序</a></li><li class="dropdown-subitem"><a href="/blog/project/mobile/" class="nav-link">移动端开发笔记</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/tool/" class="nav-link">其他</a></div><div class="nav-item"><a href="https://github.com/verneyZhou" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><!----> <span class="title" style="display:;">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/about/" class="nav-link">ME</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Solidity入门笔记02</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/more/web3/solidity-learn02.html#练习" class="sidebar-link">练习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test17" class="sidebar-link">test17</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test18" class="sidebar-link">test18</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test19" class="sidebar-link">test19</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test20" class="sidebar-link">test20</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test21" class="sidebar-link">test21</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#test22" class="sidebar-link">test22</a></li></ul></li><li><a href="/blog/more/web3/solidity-learn02.html#示例" class="sidebar-link">示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#简单读写合约" class="sidebar-link">简单读写合约</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#投票合约" class="sidebar-link">投票合约</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#秘密竞拍合约" class="sidebar-link">秘密竞拍合约</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#交易合约" class="sidebar-link">交易合约</a></li><li class="sidebar-sub-header"><a href="/blog/more/web3/solidity-learn02.html#公开拍卖合约" class="sidebar-link">公开拍卖合约</a></li></ul></li><li><a href="/blog/more/web3/solidity-learn02.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-0c557b5e><div class="articleInfo" data-v-0c557b5e><ul class="breadcrumbs" data-v-0c557b5e><li data-v-0c557b5e><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-0c557b5e></a></li> <li data-v-0c557b5e><a href="/blog/categories/?category=more" title="分类" data-v-0c557b5e>more</a></li><li data-v-0c557b5e><a href="/blog/categories/?category=web3" title="分类" data-v-0c557b5e>web3</a></li></ul> <div class="info" data-v-0c557b5e><div title="作者" class="author iconfont icon-touxiang" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>阿沐</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>2022-07-17</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Solidity入门笔记02<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="solidity入门笔记02"><a href="#solidity入门笔记02" class="header-anchor">#</a> Solidity入门笔记02</h1> <h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <h3 id="test17"><a href="#test17" class="header-anchor">#</a> test17</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
PAYABLE 接收ETH的函数修饰符
https://www.it1129.com/2022/02/26/payable-%e6%8e%a5%e6%94%b6eth%e7%9a%84%e5%87%bd%e6%95%b0%e4%bf%ae%e9%a5%b0%e7%ac%a6/

测试该合约，需要把合约通过remix 发布到 Ganache 测试环境中。然后remix 连接到本地ganache 环境
HTTP://127.0.0.1:7545 。 发布时输入10个ETH

 */</span>



<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>

contract Account <span class="token punctuation">{</span>
    <span class="token comment">// 账号持有人可以接收Ether，也就是发布该合约的创建者账号</span>
    address payable <span class="token keyword">public</span> owner<span class="token punctuation">;</span>

    <span class="token comment">//构造函数中声明 Payable，在发布的时候可以给该合约发送ETH</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> payable <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> <span class="token function">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Function to deposit Ether into this contract.</span>
    <span class="token comment">// 声明为payable的函数在调用都可以给该合约发送ETH</span>
    <span class="token comment">// 合约账号的余额会自动更新</span>
    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token comment">//如果不加入该方法，在metamask 中把该合约当Token来引入后后无法看到余额</span>
     <span class="token comment">//因为这也正是ERC20 的接口</span>
    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token parameter">address account</span><span class="token punctuation">)</span> <span class="token keyword">public</span>  view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Call this function along with some Ether.</span>
    <span class="token comment">//调用该函数并发送ETH会报错，因为没有声明为payable  The function will throw an error since this function is not payable.</span>
    <span class="token keyword">function</span> <span class="token function">notPayable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span><span class="token punctuation">}</span>


    <span class="token comment">//从该合约中提取合约所有的ETH 到该合约的创建者</span>
    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// get the amount of Ether stored in this contract</span>
        uint amount <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>

        <span class="token comment">// send all Ether to owner</span>
        <span class="token comment">// Owner can receive Ether since the address of owner is payable</span>
        <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> owner<span class="token punctuation">.</span>call<span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to send Ether&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//转账功能</span>
    <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token parameter">address payable _to<span class="token punctuation">,</span> uint _amount</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// Note that &quot;to&quot; is declared as payable</span>
        <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> _to<span class="token punctuation">.</span>call<span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> _amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to send Ether&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//注意如果没有该方法无法接收来自metamask 的转入ETH</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token comment">/**
通过以下方法可以发送Ether：
1.&lt;address payable&gt;.transfer(uint256 amount) 发送 amount/Wei 到address (消耗2300 gas,失败时抛出 error)
2.&lt;address payable&gt;.send(uint256 amount) 发送amount/Wei 到address (消耗2300 gas,失败时返回false)
3.&lt;address payable&gt;.call{value: amount,gas:可选}(“”) 发送amount/Wei 到address ，该方法转发所有Gas 或者参数中的gas 值，返回bool。该方法加上防止重入的函数修饰器是目前推荐的方法。

通过以方法可以接收Ether：
1.receive() external payable
2.fallback() external payable
注：当调用一个不存在的合约方法时，fallback 也会被执行。
 */</span>


contract ReceiveEther <span class="token punctuation">{</span>
    <span class="token comment">/*
      fallback() or receive() 如何选择

           发送 Ether
               |
         msg.data 是否为空
              / \
            yes  no
            /     \
receive() 是否存在?  fallback()
         /   \
        yes   no
        /      \
    receive()   fallback()
    */</span>

    <span class="token comment">// msg.data 必须为空 注意没有 function 修饰，必须声明为external ，不传参，无返回值</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">//   msg.data 不为空 注意没有 function 修饰，必须声明为external ，不传参，无返回值</span>
    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">//如果不加入该方法，在metamask 中import token 后无法看到balance</span>
    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token parameter">address account</span><span class="token punctuation">)</span> external view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract SendEther <span class="token punctuation">{</span>
    bool <span class="token keyword">public</span> locked<span class="token punctuation">;</span>
    modifier <span class="token function">noReentrancy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">,</span> <span class="token string">&quot;No reentrancy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        _<span class="token punctuation">;</span>
        locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">sendViaTransfer</span><span class="token punctuation">(</span><span class="token parameter">address payable _to</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        <span class="token comment">// 不推荐.</span>
        _to<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">sendViaSend</span><span class="token punctuation">(</span><span class="token parameter">address payable _to</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        <span class="token comment">// 返回 boolean 值表示是否成功 </span>
        <span class="token comment">// 不推荐.</span>
        bool sent <span class="token operator">=</span> _to<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>sent<span class="token punctuation">,</span> <span class="token string">&quot;Failed to send Ether&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">sendViaCall</span><span class="token punctuation">(</span><span class="token parameter">address payable _to</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable noReentrancy <span class="token punctuation">{</span>
        <span class="token comment">// 返回 boolean 值表示是否成功 </span>
        <span class="token comment">// 该方法配合防止重入的函数修饰器是当前推荐的方法</span>
        <span class="token punctuation">(</span>bool sent<span class="token punctuation">,</span> bytes memory data<span class="token punctuation">)</span> <span class="token operator">=</span> _to<span class="token punctuation">.</span>call<span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>sent<span class="token punctuation">,</span> <span class="token string">&quot;Failed to send Ether&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="test18"><a href="#test18" class="header-anchor">#</a> test18</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
CALL, DELEGATECALL 调用其他合约
https://www.it1129.com/2022/02/27/call-delegatecall-%e8%b0%83%e7%94%a8%e5%85%b6%e4%bb%96%e5%90%88%e7%ba%a6/

call/delegatecall 都是调用其他合约的底层方法，都返回bool，表示是否成功的调用，或者是失败引起了EVM异常。该方法无法直接访问函数返回结果(因为需要事前知道编码和返回结果大小)，即使返回true，并不能说操作成功了，只是没有出现异常，比如调用可以被fallback()函数接收而返回true。

在中大型的项目中，不可能在两三个智能合约中实现所有的功能，为了项目的协同分式，会把代码按功能划分到不同的库或者合约中，并提供接口互相调用。在Solidity中，如果只是为了代码复用，可以把公共代码抽出来，部署到一个library中，后面就可以像调用Java库，python 库一样使用了。但是Solidity library中不允许定义任何storage类型的变量，这就意味着library不能修改合约的状态。如果需要修改合约状态，我们需要部署一个新的合。这就是delegatecall存在的原因。

类似delegatecall 的函数还有 callcode，但在0.5.0 已经移除，实际上，可以认为delegatecall是callcode的一个bugfix版本，官方已经不建议使用callcode了。


 */</span>




 <span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>


<span class="token comment">/**
call 使用示例：
 */</span>
contract <span class="token constant">A</span> <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> sender<span class="token punctuation">;</span>
    string <span class="token keyword">public</span>  message<span class="token punctuation">;</span>
    uint  <span class="token keyword">public</span> num<span class="token punctuation">;</span>
    event <span class="token function">ReceivedA</span><span class="token punctuation">(</span>address caller<span class="token punctuation">,</span> uint amount<span class="token punctuation">,</span> string message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;Fallback was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>external payable
    <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;receive was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">string memory _message<span class="token punctuation">,</span> uint _num</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sender<span class="token operator">=</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        message<span class="token operator">=</span>_message<span class="token punctuation">;</span>
        num<span class="token operator">=</span>_num<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> _message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract <span class="token constant">B</span> <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> sender<span class="token punctuation">;</span>
    string <span class="token keyword">public</span>  message<span class="token punctuation">;</span>
    uint  <span class="token keyword">public</span> num<span class="token punctuation">;</span>
    event <span class="token function">ResponseB</span><span class="token punctuation">(</span>address caller<span class="token punctuation">,</span>bool success<span class="token punctuation">,</span> bytes data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    event <span class="token function">ReceivedB</span><span class="token punctuation">(</span>address caller<span class="token punctuation">,</span> uint amount<span class="token punctuation">,</span> string message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果没有A的源码，但有A的地址，与方法签名，那么就可以通过call 与 发起调用 </span>
    <span class="token keyword">function</span> <span class="token function">testCallFoo</span><span class="token punctuation">(</span><span class="token parameter">address payable _addrA<span class="token punctuation">,</span>string memory _message<span class="token punctuation">,</span> uint _num</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        <span class="token comment">// 也可以设置发布ETH 与 自定义Gas 如: _addr.call{value: msg.value, gas: 5000}</span>
        <span class="token comment">//注意abi.encodeWithSignature(&quot;foo(string,uint256)&quot;, &quot;call foo&quot;, 123) 虽然A 的方法签名写的是 uint ，但此处还是需要明确指明为 uint256</span>
        <span class="token comment">// (bool success, bytes memory data) = _addrA.call{value: msg.value}(</span>
        <span class="token comment">//     abi.encodeWithSignature(&quot;foo(string,uint256)&quot;, &quot;call foo&quot;, 123)</span>
        <span class="token comment">// );</span>
        <span class="token comment">//如果有A的源码 可以使用 encodeWithSelector</span>
        sender<span class="token operator">=</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        message<span class="token operator">=</span>_message<span class="token punctuation">;</span>
        num<span class="token operator">=</span>_num<span class="token punctuation">;</span>
        <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span> bytes memory data<span class="token punctuation">)</span> <span class="token operator">=</span> _addrA<span class="token punctuation">.</span>call<span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span>foo<span class="token punctuation">.</span>selector<span class="token punctuation">,</span>_message<span class="token punctuation">,</span> _num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">ResponseB</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>success<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//因为向A 发起调用时，msg.value-10 剩下10Wei 是进了B 自己口袋，其余的才到了A的口袋</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedB</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;Fallback was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>external payable
    <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedB</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;receive was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用一个不存在的函数</span>
    <span class="token keyword">function</span> <span class="token function">testCallDoesNotExist</span><span class="token punctuation">(</span><span class="token parameter">address _addrA</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span> bytes memory data<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_addrA</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">&quot;doesNotExist()&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        emit <span class="token function">ResponseB</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>success<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>




<span class="token comment">/**
以下是delegatecall 示例：
 */</span>

contract <span class="token constant">A</span> <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> sender<span class="token punctuation">;</span>
    string <span class="token keyword">public</span>  message<span class="token punctuation">;</span>
    uint  <span class="token keyword">public</span> num<span class="token punctuation">;</span>
    event <span class="token function">ReceivedA</span><span class="token punctuation">(</span>address caller<span class="token punctuation">,</span> uint amount<span class="token punctuation">,</span> string message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;Fallback was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>external payable
    <span class="token punctuation">{</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;receive was called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">string memory _message<span class="token punctuation">,</span> uint _num</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sender<span class="token operator">=</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        message<span class="token operator">=</span>_message<span class="token punctuation">;</span>
        num<span class="token operator">=</span>_num<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
        emit <span class="token function">ReceivedA</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> _message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract <span class="token constant">B</span> <span class="token punctuation">{</span>
     <span class="token comment">// NOTE: 此时状态变量顺序也类型都必须与A 的相同</span>
    address <span class="token keyword">public</span> sender<span class="token punctuation">;</span>
    string <span class="token keyword">public</span>  message<span class="token punctuation">;</span>
    uint  <span class="token keyword">public</span> num<span class="token punctuation">;</span>
    event <span class="token function">ResponseB</span><span class="token punctuation">(</span>address caller<span class="token punctuation">,</span>bool success<span class="token punctuation">,</span> bytes data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">testCallFoo</span><span class="token punctuation">(</span><span class="token parameter">address payable _addrA<span class="token punctuation">,</span>string memory _message<span class="token punctuation">,</span> uint _num</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        <span class="token comment">// 自定义Gas 如: _addr.call{gas: 5000} 不能带 value: msg.value, </span>
        <span class="token comment">//注意abi.encodeWithSignature(&quot;foo(string,uint256)&quot;, &quot;call foo&quot;, 123) 虽然A 的方法签名写的是 uint ，但此处还是需要明确指明为 uint256</span>
        <span class="token comment">// (bool success, bytes memory data) = _addrA.call(</span>
        <span class="token comment">//     abi.encodeWithSignature(&quot;foo(string,uint256)&quot;, &quot;call foo&quot;, 123)</span>
        <span class="token comment">// );</span>
        sender<span class="token operator">=</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        message<span class="token operator">=</span>_message<span class="token punctuation">;</span>
        num<span class="token operator">=</span>_num<span class="token punctuation">;</span>
        <span class="token punctuation">(</span>bool success<span class="token punctuation">,</span> bytes memory data<span class="token punctuation">)</span> <span class="token operator">=</span> _addrA<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span>foo<span class="token punctuation">.</span>selector<span class="token punctuation">,</span>_message<span class="token punctuation">,</span> _num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">ResponseB</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>success<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">/**
在文章 call/delegatecall 讲述了调用合约的两个底层方法，但其实还有另外的方法，虽然这种办法官方文档写着是不推荐，但做为示例让各位知道还能这么调用。
 */</span>

<span class="token comment">//如下文件名字为foo.sol</span>
contract CallB <span class="token punctuation">{</span>
    uint <span class="token keyword">public</span> x<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> value<span class="token punctuation">;</span>
    <span class="token comment">//设置状态亦是X</span>
    <span class="token keyword">function</span> <span class="token function">setX</span><span class="token punctuation">(</span><span class="token parameter">uint _x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> _x<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//当调用 setXandSendEth 可以通过该方法获得余额</span>
    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">setXandSendEth</span><span class="token punctuation">(</span><span class="token parameter">uint _x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint<span class="token punctuation">,</span> uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> _x<span class="token punctuation">;</span>
        value <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">import</span> <span class="token punctuation">{</span>Callee<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./foo.sol&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//使用import 引入另外一个合约</span>
contract Caller <span class="token punctuation">{</span>
    <span class="token comment">//虽然声明为合约类型，但在Remix 中可以看到最终还是转入的Callee的地址</span>
    <span class="token comment">//所以其实跟方法setXFromAddress 其实是一样的，只是少了一行转换的语名</span>
    <span class="token keyword">function</span> <span class="token function">setX</span><span class="token punctuation">(</span><span class="token parameter">Callee _callee<span class="token punctuation">,</span> uint _x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        uint x <span class="token operator">=</span> _callee<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">setXFromAddress</span><span class="token punctuation">(</span><span class="token parameter">address _addr<span class="token punctuation">,</span> uint _x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        Callee callee <span class="token operator">=</span> <span class="token function">Callee</span><span class="token punctuation">(</span>_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        callee<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment">//同时发送ETH 到 _callee</span>
    <span class="token keyword">function</span> <span class="token function">setXandSendEth</span><span class="token punctuation">(</span><span class="token parameter">Callee _callee<span class="token punctuation">,</span> uint _x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>uint x<span class="token punctuation">,</span> uint value<span class="token punctuation">)</span> <span class="token operator">=</span> _callee<span class="token punctuation">.</span>setXandSendEth<span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span>_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="test19"><a href="#test19" class="header-anchor">#</a> test19</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
通过NEW 创建合约

如果A 合约知道B合约的完整代码，那么可以通过new 关键字在A 内创建B 的合约实例。创建 B 实例时可以通过 value 参数发送ETH，但却无法指定或者说限制gas 的参数。如果由于栈溢出，余额不足或者其他原因导致创建失败，会抛出异常。

使用new 创建的合约B实例的地址是根据A的地址再加上一个计数器(根据 solidity 文档，该计数器为nonce),如果在new 时加入salt 参数，合约B 的地址计算是使用A 的地址，salt(bytes32 类型 )值，B的字节码，B构造函数的参数计算出来的新的地址。因为不使用Nonce 做计数，有了这一特性，我们可以提前计算出合约B 的地址。
 */</span>

<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>

contract Bus <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> owner<span class="token punctuation">;</span>
    string <span class="token keyword">public</span> model<span class="token punctuation">;</span>
    address <span class="token keyword">public</span> busAddr<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>address _owner<span class="token punctuation">,</span> string memory _model<span class="token punctuation">)</span> payable <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
        model <span class="token operator">=</span> _model<span class="token punctuation">;</span>
        busAddr <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract BusFactory <span class="token punctuation">{</span>
    Bus<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> busList<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span> string memory _model</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        Bus bus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> _model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        busList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//与create 不一样，向create2输入同样的参数时，第二次就创建失败了,因为同一个地址只能有一份合约实例</span>
    <span class="token keyword">function</span> <span class="token function">create2</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span>string memory _model<span class="token punctuation">,</span>bytes32 _salt</span><span class="token punctuation">)</span> <span class="token keyword">public</span> 
    <span class="token punctuation">{</span>
        Bus bus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token literal-property property">salt</span><span class="token operator">:</span> _salt<span class="token punctuation">}</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> _model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        busList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">createAndSendEther</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span> string memory _model</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        Bus bus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> _model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        busList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">create2AndSendEther</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span>string memory _model<span class="token punctuation">,</span>bytes32 _salt</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        Bus bus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token literal-property property">salt</span><span class="token operator">:</span> _salt<span class="token punctuation">}</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> _model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        busList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">getBus</span><span class="token punctuation">(</span><span class="token parameter">uint _index</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">address owner<span class="token punctuation">,</span>string memory model<span class="token punctuation">,</span>address bus_addr<span class="token punctuation">,</span>uint balance</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Bus bus <span class="token operator">=</span> busList<span class="token punctuation">[</span>_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>bus<span class="token punctuation">.</span><span class="token function">owner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bus<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bus<span class="token punctuation">.</span><span class="token function">busAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">address</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
如下示例计算如何计算salted 加盐的合约创建。

什么是加盐
盐 (Salt) 在密码学中，是指通过在密码任意固定位置插入特定的字符串，让散列后的结果和使用原始密码的散列结果不相符，这种过程称之为 “加盐”。密码不能以明文形式保存到数据库中，否则数据泄露密码就会被知道。而一般的加密方式由于加密规则固定，很容易被破解，安全系数不高。密码加盐的加密方式，能很好的解决这一点。
 */</span>

contract Bus <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> owner<span class="token punctuation">;</span>
    string <span class="token keyword">public</span> model<span class="token punctuation">;</span>
    address <span class="token keyword">public</span> busAddr<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>address _owner<span class="token punctuation">,</span> string memory _model<span class="token punctuation">)</span> payable <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
        model <span class="token operator">=</span> _model<span class="token punctuation">;</span>
        busAddr <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract BusFactory <span class="token punctuation">{</span>
    event <span class="token function">Log</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">calculateSaltedAddress</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span> string memory _model<span class="token punctuation">,</span>bytes32 _salt</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
       address predictedAddress <span class="token operator">=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token function">uint160</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">bytes1</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>_salt<span class="token punctuation">,</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>Bus<span class="token punctuation">)</span><span class="token punctuation">.</span>creationCode<span class="token punctuation">,</span>abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span>_model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;predictedAddress&quot;</span><span class="token punctuation">,</span>predictedAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Bus d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">{</span><span class="token literal-property property">salt</span><span class="token operator">:</span> _salt<span class="token punctuation">}</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span>_model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;d address ==&gt; &quot;</span><span class="token punctuation">,</span><span class="token function">address</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> predictedAddress<span class="token punctuation">,</span><span class="token string">&quot;address is not the same&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
<span class="token punctuation">}</span>

<span class="token comment">/**
solidity 官方示例只带一个参数是这样计算的：
address predictedAddress = address(uint160(uint(keccak256(abi.encodePacked(bytes1(0xff), address(this),salt, keccak256(abi.encodePacked(type(D).creationCode,arg)))))));
但当参数有多个需要使用abi.encode 串起各参数。

也可以使用create2 计算到合约的地址，并能发布合约，请查看 create2 发布合约:

在上一文章 通过new 在创建合约 我们知道如何使用new 创建合约，本文章通过示例展示如何通过create2 创建合约，该效果跟 new 加上salted 是一样的。都是可预先计算的合约地址。
https://www.it1129.com/2022/02/28/%e4%bd%bf%e7%94%a8-create2-%e5%8f%91%e5%b8%83%e5%90%88%e7%ba%a6/
 */</span>

contract DeployFactory <span class="token punctuation">{</span>
    event <span class="token function">Deployed</span><span class="token punctuation">(</span>address addr<span class="token punctuation">,</span> uint salt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1. 获取需要发布的合约字节友 bytecode of contract to be deployed</span>
    <span class="token comment">// NOTE: _owner and _foo 是 TestContract构造函数的参数</span>
    <span class="token keyword">function</span> <span class="token function">getBytecode</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span> uint _foo</span><span class="token punctuation">)</span> <span class="token keyword">public</span> pure <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bytes memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bytes memory bytecode <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>TestContract<span class="token punctuation">)</span><span class="token punctuation">.</span>creationCode<span class="token punctuation">;</span>
        <span class="token keyword">return</span> abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> _foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 计算合约的地址</span>
    <span class="token comment">// NOTE: _salt 随机数</span>
    <span class="token keyword">function</span> <span class="token function">precomputeDeployContractAddress</span><span class="token punctuation">(</span><span class="token parameter">bytes memory bytecode<span class="token punctuation">,</span> uint _salt</span><span class="token punctuation">)</span><span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">address</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        bytes32 hash <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">bytes1</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _salt<span class="token punctuation">,</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token function">uint160</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 发布合约</span>
    <span class="token comment">// NOTE:</span>
    <span class="token comment">// Check the event log Deployed which contains the address of the deployed TestContract.</span>
    <span class="token comment">// The address in the log should equal the address computed from above.</span>
    <span class="token keyword">function</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token parameter">address _owner<span class="token punctuation">,</span> uint _foo <span class="token punctuation">,</span> uint _salt</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token punctuation">{</span>
        address addr<span class="token punctuation">;</span>
        bytes memory bytecode<span class="token operator">=</span><span class="token function">getBytecode</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span>_foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        NOTE: 如何使用 create2 发布合约并返回合约地址

        create2(v, p, n, s)
        v 是需要发送的Wei
        合约代码是在内容地址于 p to p + n
        and return the new address
        where new address = first 20 bytes of keccak256(0xff + address(this) + s + keccak256(mem[p…(p+n)))
              s = big-endian 256-bit value
        */</span>
        assembly <span class="token punctuation">{</span>
            <span class="token literal-property property">addr</span> <span class="token operator">:</span><span class="token operator">=</span> <span class="token function">create2</span><span class="token punctuation">(</span>
                <span class="token function">callvalue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//发送当前调用的Wei 值 官方注解是这样的：Wei sent together with the current call</span>
                <span class="token comment">// Actual code starts after skipping the first 32 bytes</span>
                <span class="token function">add</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">mload</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Load the size of code contained in the first 32 bytes</span>
                _salt <span class="token comment">// Salt from function arguments</span>
            <span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token parameter"><span class="token function">extcodesize</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">revert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//不使用create2 计算出来的合约地址值</span>
        address addr2 <span class="token operator">=</span> <span class="token function">precomputeDeployContractAddress</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span>_salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>addr2<span class="token operator">==</span>addr<span class="token punctuation">,</span><span class="token string">&quot;address is not match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">Deployed</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> _salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract TestContract <span class="token punctuation">{</span>
    address <span class="token keyword">public</span> owner<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> foo<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>address _owner<span class="token punctuation">,</span> uint _foo<span class="token punctuation">)</span> payable <span class="token punctuation">{</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
        foo <span class="token operator">=</span> _foo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
在remix 发布后 在方法 deploy 输入：
0x5B38Da6a701c568545dCfcB03FcB875f56beddC4,10,”0x666f4D0000000000000000000000000000000000000000000000000000000000″

但可以发布TestContract 且在日志中知道新合约的地址，使用该地址，可以在remix 重新加载该地址的合约。
 */</span>
</code></pre></div><h3 id="test20"><a href="#test20" class="header-anchor">#</a> test20</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
IMPORT 引入合约

类似于js(ES6) solidity 支持import 语句从其他合约文件中引入合约，但跟js 不一样的是没有default export 默认导出。看如下几种使用方法：

import “filename”;
filename 是引入路径，这种写法会把filename 中所有全局符号（合约，struct，函数，错误定义等） 引入到当前文件的全局范围，但这种方式并不推荐，容易引起命名冲突。

import * as symbolName from “filename”;
创建一个全局的symbolName ，然后filename中的所有symbol 都可以通过 symbolName.symbol 引用到
等同于：import “filename” as symbolName;

import {symbol1 as alias, symbol2} from “filename”;
这种是加入别名
 */</span>



<span class="token comment">/**
以下文件是Foo.sol
 */</span>

<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>

struct Position <span class="token punctuation">{</span>
    uint x<span class="token punctuation">;</span>
    uint y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

error <span class="token function">InsufficientBalance</span><span class="token punctuation">(</span>address caller<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">addTowUint</span><span class="token punctuation">(</span><span class="token parameter">uint x<span class="token punctuation">,</span> uint y</span><span class="token punctuation">)</span> pure <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

contract Foo <span class="token punctuation">{</span>
    string <span class="token keyword">public</span> name <span class="token operator">=</span> <span class="token string">&quot;Foo&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>





<span class="token comment">/**
以下文件为Import.sol
 */</span>

<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>

<span class="token comment">// 从当前目录中引入 Foo.sol  这种方法找不推荐</span>
<span class="token keyword">import</span> <span class="token string">&quot;./Foo.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// import {symbol1 as alias, symbol2} from &quot;filename&quot;;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>InsufficientBalance<span class="token punctuation">,</span> addTowUint <span class="token keyword">as</span> func<span class="token punctuation">,</span> Position<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Foo.sol&quot;</span><span class="token punctuation">;</span>

contract ImportTest <span class="token punctuation">{</span>
   <span class="token comment">//因为import &quot;./Foo.sol&quot;; Foo 已经是全局了，</span>
    Foo <span class="token keyword">public</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">function</span> <span class="token function">getFooName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">string memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> foo<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="test21"><a href="#test21" class="header-anchor">#</a> test21</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
LIBRARY 库

Lib库与合约类似，只能发布一次，通过EVM 的 DELEGATECALL 特性实现代码的复用。 关于delegatecall 的可以参考 call, delegatecall 调用其他合约 。当调用库函数时其代码是在调用者的上下文中执行的，比如 this 指向当前调用者，可以访问调用者的storage。lib 有如下限制：
1.不能定义状态变量
2.不能继承与被继承
3.不能接收ETH
4.发布后无法销毁
 */</span>


<span class="token comment">/**
MathLib.sol
 */</span>

<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>
library MathLib <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">uint x<span class="token punctuation">,</span> uint y</span><span class="token punctuation">)</span> <span class="token keyword">public</span> pure <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint z <span class="token operator">=</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>z <span class="token operator">&gt;=</span> x<span class="token punctuation">,</span> <span class="token string">&quot;uint overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MathLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./MathLib.sol&quot;</span><span class="token punctuation">;</span>
contract TestLib<span class="token punctuation">{</span>
    event <span class="token function">Log</span><span class="token punctuation">(</span>string msg<span class="token punctuation">,</span>uint num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    using MathLib <span class="token keyword">for</span> uint<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">test_add1</span><span class="token punctuation">(</span><span class="token parameter">uint x1<span class="token punctuation">,</span>uint x2</span><span class="token punctuation">)</span> <span class="token keyword">public</span>  
    <span class="token punctuation">{</span>
        uint result<span class="token operator">=</span> MathLib<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test_lib1 &quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">test_add2</span><span class="token punctuation">(</span><span class="token parameter">uint x1<span class="token punctuation">,</span>uint x2</span><span class="token punctuation">)</span> <span class="token keyword">public</span>  
    <span class="token punctuation">{</span>
        uint result<span class="token operator">=</span> x1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test_lib2 &quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
我们并不打算在此示例里实现什么有用的库，而是为大家展示lib 的用法。在TestLib 中展示了lib 的使用方法，
一种是MathLib.add ，这种写法就像MathLib 是TestLib 的基类一样，但其实并没有这种关系，因为如果是基类的话，MathLib.add 就是一种内部函数调用(internal call)，MathLib的代码在编译的时候会拷贝到TestLib，调用的时候采用JUMP 指令。但Libary 使用的是 DELEGATECALL，是外部函数调用(external call),因此msg.sender, msg. value 跟 this 都跟调用者的是一样的。大家可以尝试在打印出来即可验证。

另外一种使用方法是如test_add2中 的一样，采用 using MathLib for uint; 把 MathLib 的代码绑定到uint 这种类型运行的上下文中，这样在当前合约的运行环境中，uint 就有了MathLib 中的所有函数。因此可以直接调用：x1.add(x2)。 注意使用这种方式，当调用MathLib 中的函数时传递的第一个参数就是uint。

除此还可以使用 using MathLib for *; 把MathLib 绑定到任意类型中。这两种使用方式都有可能出现第一个参数的传递出现类型不匹配的情况， 此时编译出现类型错误：TypeError: Member “add” not found or not visible after argument-dependent lookup in int256.
 */</span>



<span class="token comment">// 所有的外部库函数调用实际是EVM 函数调用，所以如果你传递的是memory 类型，或者值类型，这些参数都是以拷贝的方式进行传递，除非把参数声明为storage 类型。如下示例：</span>


<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>
library ArrayLib <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token parameter">uint<span class="token punctuation">[</span><span class="token punctuation">]</span> storage self<span class="token punctuation">,</span> uint value</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> value<span class="token punctuation">)</span> 
                <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">type</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ArrayLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./ArrayLib.sol&quot;</span><span class="token punctuation">;</span>
contract TestArrayLib <span class="token punctuation">{</span>
    using ArrayLib <span class="token keyword">for</span> uint<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    uint<span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token parameter">uint value</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span> 
        data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">uint _old<span class="token punctuation">,</span> uint _new</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span> 
        <span class="token comment">//ArrayLib传递的是storage 从而避免了拷贝</span>
        uint index <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>_old<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token function">type</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span>
            data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_new<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            data<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> _new<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre></div><h3 id="test22"><a href="#test22" class="header-anchor">#</a> test22</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
使用KECCAK256 获取HASH 字符串

先看官方的方法签名与解析：
keccak256(bytes memory) returns (bytes32) compute the Keccak-256 hash of the input
输入bytes 数值，返回的是Keccak-256 hash 值。
在0.5.0 版本前该方法也叫sha3 。

keccak256的返回值是bytes32类型，意味着其返回值是一个256位的随机数。一般使用一些全局属性，比如时间block.timestamp,msg.sender,block.number等全局属性来构造随机数。
 */</span>


<span class="token comment">// SPDX-License-Identifier: MIT</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.0</span><span class="token punctuation">;</span>

contract HashHelper <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">generateHash</span><span class="token punctuation">(</span><span class="token parameter">string memory _text<span class="token punctuation">,</span>uint _num<span class="token punctuation">,</span>address _addr</span><span class="token punctuation">)</span> <span class="token keyword">public</span> pure <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>_text<span class="token punctuation">,</span> _num<span class="token punctuation">,</span> _addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//  hash 冲突问题</span>
    <span class="token comment">// 当输入多个参数做has时，因此有可能最后encodePacked 出来的bytes 是一样的，如下面例子。此时可以使用 abi.encode</span>
    <span class="token keyword">function</span> <span class="token function">collision_test</span><span class="token punctuation">(</span><span class="token parameter">string memory _text<span class="token punctuation">,</span> string memory _anotherText</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        pure
        <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bytes32</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// return keccak256(abi.encodePacked(_text, _anotherText));</span>
        <span class="token comment">// encodePacked(AAA, BBB) 值为 AAABBB</span>
        <span class="token comment">// encodePacked(AA, ABBB) 值为 AAABBB</span>
        <span class="token comment">//因为最后的结果都是一样的，所有会导致keccak256 出来的值是一样的。所以需要使用 abi.encode</span>
        <span class="token keyword">return</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_text<span class="token punctuation">,</span> _anotherText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 假设我们的游戏要保证有80% 的概率能赢，查看如何实现：</span>

 <span class="token keyword">function</span> <span class="token function">test_rate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span><span class="token parameter">bool</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      bytes32 hash_msg<span class="token operator">=</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">uint256</span><span class="token punctuation">(</span>hash_msg<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span>  <span class="token operator">&lt;</span> <span class="token number">70</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 但官方文档是建议我们不能依赖 block.timestamp or blockhash 做为随机源。以上只做为示例学习使用keccak256。</span>

</code></pre></div><h2 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h2> <h3 id="简单读写合约"><a href="#简单读写合约" class="header-anchor">#</a> 简单读写合约</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// SPDX-License-Identifier: GPL-3.0 // 第一行是说明源代码是根据GPL 3.0版本授权的</span>

<span class="token comment">// 关键字 pragma 版本标识指令，用来启用某些编译器检查， 版本 标识pragma 指令通常只对本文件有效，所以我们需要把这个版本 标识pragma 添加到项目中所有的源文件。 如果使用了 import 导入 其他的文件, 标识pragma 并不会从被导入的文件，加入到导入的文件中。</span>
pragma solidity <span class="token operator">&gt;=</span><span class="token number">0.4</span><span class="token number">.16</span> <span class="token operator">&lt;</span><span class="token number">0.9</span><span class="token number">.0</span><span class="token punctuation">;</span> <span class="token comment">// 告诉编译器源代码所适用的Solidity版本为&gt;=0.4.16 及 &lt;0.9.0 ; 这样的说明是为了确保合约不会在新的编译器版本中发生异常的行为。关键字 pragma 是告知编译器如何处理源代码的通用指令</span>


<span class="token comment">// Solidity中智能合约的含义就是一组代码（它的 功能 )和数据（它的 状态 ）的集合，并且它们是位于以太坊区块链的一个特定地址上的。</span>
contract SimpleStorage <span class="token punctuation">{</span>
    uint storedData<span class="token punctuation">;</span> <span class="token comment">// 这一行代码声明了一个名为``storedData``的状态变量，其类型为 uint (256位无符号整数）</span>

    <span class="token comment">// 关键字“public”让这些变量可以从外部读取</span>
    <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">uint x</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        storedData <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> storedData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="投票合约"><a href="#投票合约" class="header-anchor">#</a> 投票合约</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
投票合约
我们的想法是为每个（投票）表决创建一份合约，为每个选项提供简称。 然后作为合约的创造者——即主席，将给予每个独立的地址以投票权。
地址后面的人可以选择自己投票，或者委托给他们信任的人来投票。
在投票时间结束时，winningProposal() 将返回获得最多投票的提案。
 */</span>


<span class="token comment">// SPDX-License-Identifier: GPL-3.0</span>
pragma solidity <span class="token operator">&gt;=</span><span class="token number">0.7</span><span class="token number">.0</span> <span class="token operator">&lt;</span><span class="token number">0.9</span><span class="token number">.0</span><span class="token punctuation">;</span>

<span class="token comment">/// @title 委托投票</span>
contract Ballot <span class="token punctuation">{</span>
    <span class="token comment">// 这里声明了一个新的复合类型用于稍后的变量</span>
    <span class="token comment">// 它用来表示一个选民</span>
    struct Voter <span class="token punctuation">{</span>
        uint weight<span class="token punctuation">;</span> <span class="token comment">// 计票的权重</span>
        bool voted<span class="token punctuation">;</span>  <span class="token comment">// 若为真，代表该人已投票</span>
        address delegate<span class="token punctuation">;</span> <span class="token comment">// 被委托人</span>
        uint vote<span class="token punctuation">;</span>   <span class="token comment">// 投票提案的索引</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 提案的类型</span>
    struct Proposal <span class="token punctuation">{</span>
        bytes32 name<span class="token punctuation">;</span>   <span class="token comment">// 简称（最长32个字节）</span>
        uint voteCount<span class="token punctuation">;</span> <span class="token comment">// 得票数</span>
    <span class="token punctuation">}</span>

    address <span class="token keyword">public</span> chairperson<span class="token punctuation">;</span>

    <span class="token comment">// 这声明了一个状态变量，为每个可能的地址存储一个 `Voter`。</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token operator">=&gt;</span> Voter<span class="token punctuation">)</span> <span class="token keyword">public</span> voters<span class="token punctuation">;</span>

    <span class="token comment">// 一个 `Proposal` 结构类型的动态数组</span>
    Proposal<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> proposals<span class="token punctuation">;</span>

    <span class="token comment">/// 为 `proposalNames` 中的每个提案，创建一个新的（投票）表决</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">bytes32<span class="token punctuation">[</span><span class="token punctuation">]</span> memory proposalNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chairperson <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        voters<span class="token punctuation">[</span>chairperson<span class="token punctuation">]</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//对于提供的每个提案名称，</span>
        <span class="token comment">//创建一个新的 Proposal 对象并把它添加到数组的末尾。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> proposalNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// `Proposal({...})` 创建一个临时 Proposal 对象，</span>
            <span class="token comment">// `proposals.push(...)` 将其添加到 `proposals` 的末尾</span>
            proposals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Proposal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> proposalNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">voteCount</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 授权 `voter` 对这个（投票）表决进行投票</span>
    <span class="token comment">// 只有 `chairperson` 可以调用该函数。</span>
    <span class="token keyword">function</span> <span class="token function">giveRightToVote</span><span class="token punctuation">(</span><span class="token parameter">address voter</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
        <span class="token comment">// 若 `require` 的第一个参数的计算结果为 `false`，</span>
        <span class="token comment">// 则终止执行，撤销所有对状态和以太币余额的改动。</span>
        <span class="token comment">// 在旧版的 EVM 中这曾经会消耗所有 gas，但现在不会了。</span>
        <span class="token comment">// 使用 require 来检查函数是否被正确地调用，是一个好习惯。</span>
        <span class="token comment">// 你也可以在 require 的第二个参数中提供一个对错误情况的解释。</span>
        <span class="token function">require</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> chairperson<span class="token punctuation">,</span>
            <span class="token string">&quot;Only chairperson can give right to vote.&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>
            <span class="token operator">!</span>voters<span class="token punctuation">[</span>voter<span class="token punctuation">]</span><span class="token punctuation">.</span>voted<span class="token punctuation">,</span>
            <span class="token string">&quot;The voter already voted.&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>voters<span class="token punctuation">[</span>voter<span class="token punctuation">]</span><span class="token punctuation">.</span>weight <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voters<span class="token punctuation">[</span>voter<span class="token punctuation">]</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 把你的投票委托到投票者 `to`。</span>
    <span class="token keyword">function</span> <span class="token function">delegate</span><span class="token punctuation">(</span><span class="token parameter">address to</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
        <span class="token comment">// 传引用</span>
        Voter storage sender <span class="token operator">=</span> voters<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">.</span>voted<span class="token punctuation">,</span> <span class="token string">&quot;You already voted.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">require</span><span class="token punctuation">(</span>to <span class="token operator">!=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token string">&quot;Self-delegation is disallowed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 委托是可以传递的，只要被委托者 `to` 也设置了委托。</span>
        <span class="token comment">// 一般来说，这种循环委托是危险的。因为，如果传递的链条太长，</span>
        <span class="token comment">// 则可能需消耗的gas要多于区块中剩余的（大于区块设置的gasLimit），</span>
        <span class="token comment">// 这种情况下，委托不会被执行。</span>
        <span class="token comment">// 而在另一些情况下，如果形成闭环，则会让合约完全卡住。</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>voters<span class="token punctuation">[</span>to<span class="token punctuation">]</span><span class="token punctuation">.</span>delegate <span class="token operator">!=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            to <span class="token operator">=</span> voters<span class="token punctuation">[</span>to<span class="token punctuation">]</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>

            <span class="token comment">// 不允许闭环委托</span>
            <span class="token function">require</span><span class="token punctuation">(</span>to <span class="token operator">!=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token string">&quot;Found loop in delegation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// `sender` 是一个引用, 相当于对 `voters[msg.sender].voted` 进行修改</span>
        Voter storage delegate_ <span class="token operator">=</span> voters<span class="token punctuation">[</span>to<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Voters cannot delegate to wallets that cannot vote.</span>
        <span class="token function">require</span><span class="token punctuation">(</span>delegate_<span class="token punctuation">.</span>weight <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sender<span class="token punctuation">.</span>voted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span>delegate <span class="token operator">=</span> to<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate_<span class="token punctuation">.</span>voted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若被委托者已经投过票了，直接增加得票数</span>
            proposals<span class="token punctuation">[</span>delegate_<span class="token punctuation">.</span>vote<span class="token punctuation">]</span><span class="token punctuation">.</span>voteCount <span class="token operator">+=</span> sender<span class="token punctuation">.</span>weight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若被委托者还没投票，增加委托者的权重</span>
            delegate_<span class="token punctuation">.</span>weight <span class="token operator">+=</span> sender<span class="token punctuation">.</span>weight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 把你的票(包括委托给你的票)，</span>
    <span class="token comment">/// 投给提案 `proposals[proposal].name`.</span>
    <span class="token keyword">function</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token parameter">uint proposal</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
        Voter storage sender <span class="token operator">=</span> voters<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">.</span>voted<span class="token punctuation">,</span> <span class="token string">&quot;Already voted.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span>voted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        sender<span class="token punctuation">.</span>vote <span class="token operator">=</span> proposal<span class="token punctuation">;</span>

        <span class="token comment">// 如果 `proposal` 超过了数组的范围，则会自动抛出异常，并恢复所有的改动</span>
        proposals<span class="token punctuation">[</span>proposal<span class="token punctuation">]</span><span class="token punctuation">.</span>voteCount <span class="token operator">+=</span> sender<span class="token punctuation">.</span>weight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// @dev 结合之前所有的投票，计算出最终胜出的提案</span>
    <span class="token keyword">function</span> <span class="token function">winningProposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external view
            <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">uint winningProposal_</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint winningVoteCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> proposals<span class="token punctuation">.</span>length<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>proposals<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>voteCount <span class="token operator">&gt;</span> winningVoteCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                winningVoteCount <span class="token operator">=</span> proposals<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>voteCount<span class="token punctuation">;</span>
                winningProposal_ <span class="token operator">=</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调用 winningProposal() 函数以获取提案数组中获胜者的索引，并以此返回获胜者的名称</span>
    <span class="token keyword">function</span> <span class="token function">winnerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view
            <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bytes32 winnerName_</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        winnerName_ <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token function">winningProposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="秘密竞拍合约"><a href="#秘密竞拍合约" class="header-anchor">#</a> 秘密竞拍合约</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
秘密竞拍（盲拍）
在 投标期间 ，投标人实际上并没有发送她的出价，而只是发送一个哈希版本的出价。 由于目前几乎不可能找到两个（足够长的）值，其哈希值是相等的，因此投标人可通过该方式提交报价。 在投标结束后，投标人必须公开他们的出价：他们不加密的发送他们的出价，合约检查出价的哈希值是否与投标期间提供的相同。
 */</span>

<span class="token comment">// SPDX-License-Identifier: GPL-3.0</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.4</span><span class="token punctuation">;</span>

contract BlindAuction <span class="token punctuation">{</span>
    struct Bid <span class="token punctuation">{</span>
        bytes32 blindedBid<span class="token punctuation">;</span>
        uint deposit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    address payable <span class="token keyword">public</span> beneficiary<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> biddingEnd<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> revealEnd<span class="token punctuation">;</span>
    bool <span class="token keyword">public</span> ended<span class="token punctuation">;</span>

    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token operator">=&gt;</span> Bid<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">public</span> bids<span class="token punctuation">;</span>

    address <span class="token keyword">public</span> highestBidder<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> highestBid<span class="token punctuation">;</span>

    <span class="token comment">// 可以取回的之前的出价</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token operator">=&gt;</span> uint<span class="token punctuation">)</span> pendingReturns<span class="token punctuation">;</span>

    event <span class="token function">AuctionEnded</span><span class="token punctuation">(</span>address winner<span class="token punctuation">,</span> uint highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// Errors that describe failures.</span>

    <span class="token comment">/// The function has been called too early.</span>
    <span class="token comment">/// Try again at `time`.</span>
    error <span class="token function">TooEarly</span><span class="token punctuation">(</span>uint time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// The function has been called too late.</span>
    <span class="token comment">/// It cannot be called after `time`.</span>
    error <span class="token function">TooLate</span><span class="token punctuation">(</span>uint time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// The function auctionEnd has already been called.</span>
    error <span class="token function">AuctionEndAlreadyCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 使用 modifier 可以更便捷的校验函数的入参。</span>
    <span class="token comment">/// `onlyBefore` 会被用于后面的 `bid` 函数：</span>
    <span class="token comment">/// 新的函数体是由 modifier 本身的函数体，并用原函数体替换 `_;` 语句来组成的。</span>
    modifier <span class="token function">onlyBefore</span><span class="token punctuation">(</span><span class="token parameter">uint time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">&gt;=</span> time<span class="token punctuation">)</span> revert <span class="token function">TooLate</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    modifier <span class="token function">onlyAfter</span><span class="token punctuation">(</span><span class="token parameter">uint time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;=</span> time<span class="token punctuation">)</span> revert <span class="token function">TooEarly</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>
        <span class="token parameter">uint biddingTime<span class="token punctuation">,</span>
        uint revealTime<span class="token punctuation">,</span>
        address payable beneficiaryAddress</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beneficiary <span class="token operator">=</span> beneficiaryAddress<span class="token punctuation">;</span>
        biddingEnd <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> biddingTime<span class="token punctuation">;</span>
        revealEnd <span class="token operator">=</span> biddingEnd <span class="token operator">+</span> revealTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 可以通过 `blindedBid` = keccak256(value, fake, secret)</span>
    <span class="token comment">/// 设置一个秘密竞拍。</span>
    <span class="token comment">/// 只有在出价披露阶段被正确披露，已发送的以太币才会被退还。</span>
    <span class="token comment">/// 如果与出价一起发送的以太币至少为 “value” 且 “fake” 不为真，则出价有效。</span>
    <span class="token comment">/// 将 “fake” 设置为 true ，然后发送满足订金金额但又不与出价相同的金额是隐藏实际出价的方法。</span>
    <span class="token comment">/// 同一个地址可以放置多个出价。</span>
    <span class="token keyword">function</span> <span class="token function">bid</span><span class="token punctuation">(</span><span class="token parameter">bytes32 blindedBid</span><span class="token punctuation">)</span>
        external
        payable
        <span class="token function">onlyBefore</span><span class="token punctuation">(</span><span class="token parameter">biddingEnd</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        bids<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Bid</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">blindedBid</span><span class="token operator">:</span> blindedBid<span class="token punctuation">,</span>
            <span class="token literal-property property">deposit</span><span class="token operator">:</span> msg<span class="token punctuation">.</span>value
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 披露你的秘密竞拍出价。</span>
    <span class="token comment">/// 对于所有正确披露的无效出价以及除最高出价以外的所有出价，你都将获得退款。</span>
    <span class="token keyword">function</span> <span class="token function">reveal</span><span class="token punctuation">(</span>
        <span class="token parameter">uint<span class="token punctuation">[</span><span class="token punctuation">]</span> calldata values<span class="token punctuation">,</span>
        bool<span class="token punctuation">[</span><span class="token punctuation">]</span> calldata fake<span class="token punctuation">,</span>
        bytes32<span class="token punctuation">[</span><span class="token punctuation">]</span> calldata secret</span>
    <span class="token punctuation">)</span>
        external
        <span class="token function">onlyAfter</span><span class="token punctuation">(</span>biddingEnd<span class="token punctuation">)</span>
        <span class="token function">onlyBefore</span><span class="token punctuation">(</span><span class="token parameter">revealEnd</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint length <span class="token operator">=</span> bids<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>values<span class="token punctuation">.</span>length <span class="token operator">==</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>fake<span class="token punctuation">.</span>length <span class="token operator">==</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span>length <span class="token operator">==</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        uint refund<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Bid storage bid <span class="token operator">=</span> bids<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>uint value<span class="token punctuation">,</span> bool fake<span class="token punctuation">,</span> bytes32 secret<span class="token punctuation">)</span> <span class="token operator">=</span>
                    <span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fake<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> secret<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bid<span class="token punctuation">.</span>blindedBid <span class="token operator">!=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> fake<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 出价未能正确披露</span>
                <span class="token comment">// 不返还订金</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            refund <span class="token operator">+=</span> bid<span class="token punctuation">.</span>deposit<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fake <span class="token operator">&amp;&amp;</span> bid<span class="token punctuation">.</span>deposit <span class="token operator">&gt;=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">placeBid</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    refund <span class="token operator">-=</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 使发送者不可能再次认领同一笔订金</span>
            bid<span class="token punctuation">.</span>blindedBid <span class="token operator">=</span> <span class="token function">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>refund<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这是一个 &quot;internal&quot; 函数， 意味着它只能在本合约（或继承合约）内被调用</span>
    <span class="token keyword">function</span> <span class="token function">placeBid</span><span class="token punctuation">(</span><span class="token parameter">address bidder<span class="token punctuation">,</span> uint value</span><span class="token punctuation">)</span> internal
            <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool success</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> highestBid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>highestBidder <span class="token operator">!=</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返还之前的最高出价</span>
            pendingReturns<span class="token punctuation">[</span>highestBidder<span class="token punctuation">]</span> <span class="token operator">+=</span> highestBid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        highestBid <span class="token operator">=</span> value<span class="token punctuation">;</span>
        highestBidder <span class="token operator">=</span> bidder<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 取回出价（当该出价已被超越）</span>
    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
        uint amount <span class="token operator">=</span> pendingReturns<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里很重要，首先要设零值。</span>
            <span class="token comment">// 因为，作为接收调用的一部分，</span>
            <span class="token comment">// 接收者可以在 `transfer` 返回之前重新调用该函数。（可查看上面关于‘条件 -&gt; 影响 -&gt; 交互’的标注）</span>
            pendingReturns<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 结束拍卖，并把最高的出价发送给受益人</span>
    <span class="token keyword">function</span> <span class="token function">auctionEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        external
        <span class="token function">onlyAfter</span><span class="token punctuation">(</span><span class="token parameter">revealEnd</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ended<span class="token punctuation">)</span> revert <span class="token function">AuctionEndAlreadyCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit <span class="token function">AuctionEnded</span><span class="token punctuation">(</span>highestBidder<span class="token punctuation">,</span> highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        beneficiary<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="交易合约"><a href="#交易合约" class="header-anchor">#</a> 交易合约</h3> <div class="language-js extra-class"><pre class="language-js"><code>

<span class="token comment">// SPDX-License-Identifier: GPL-3.0  // 第一行是说明源代码是根据GPL 3.0版本授权的</span>

<span class="token comment">// 源文件将既不允许低于 0.8.4 版本的编译器编译， 也不允许高于（包含） 0.9.0 版本的编译器编译（第二个条件因使用 ^ 被添加）</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.4</span><span class="token punctuation">;</span>

contract Coin <span class="token punctuation">{</span>
    <span class="token comment">// 关键字“public”让这些变量可以从外部读取，关键字 public 自动生成一个函数，允许你在这个合约之外访问这个状态变量的当前值。如果没有这个关键字，其他的合约没有办法访问这个变量。</span>
    <span class="token comment">// 这一行声明了一个可以被公开访问的 address 类型的状态变量。address 类型是一个160位的值，且不允许任何算数操作。这种类型适合存储合约地址或外部人员的密钥对。</span>
    <span class="token comment">// 由编译器生成的函数的代码大致如下所示: function minter() external view returns (address) { return minter; }</span>
    address <span class="token keyword">public</span> minter<span class="token punctuation">;</span> 


    <span class="token comment">// 创建一个公共状态变量，但它是一个更复杂的数据类型。 该类型将address映射为无符号整数</span>
    <span class="token comment">// Mappings 可以看作是一个 哈希表 它会执行虚拟初始化，以使所有可能存在的键都映射到一个字节表示为全零的值。</span>
    <span class="token comment">/**
    function balances(address account) external view returns (uint) {
        return balances[account];
    }
     */</span>
    <span class="token function">mapping</span> <span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token operator">=&gt;</span> uint<span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>


    <span class="token comment">// 轻客户端可以通过事件针对变化作出高效的反应</span>
    <span class="token comment">// 这行声明了一个所谓的“事件（event）”，它会在 send 函数的最后一行被发出</span>
    <span class="token comment">/**
    用户界面（当然也包括服务器应用程序）可以监听区块链上正在发送的事件，而不会花费太多成本。一旦它被发出，监听该事件的listener都将收到通知。而所有的事件都包含了 from ， to 和 amount 三个参数，可方便追踪交易。
    为了监听这个事件，你可以使用如下JavaScript代码: 
    Coin.Sent().watch({}, '', function(error, result) {
        if (!error) {
            console.log(&quot;Coin transfer: &quot; + result.args.amount +
                &quot; coins were sent from &quot; + result.args.from +
                &quot; to &quot; + result.args.to + &quot;.&quot;);
            console.log(&quot;Balances now:\n&quot; +
                &quot;Sender: &quot; + Coin.balances.call(result.args.from) +
                &quot;Receiver: &quot; + Coin.balances.call(result.args.to));
        }
    })
     */</span>
    event <span class="token function">Sent</span><span class="token punctuation">(</span>address from<span class="token punctuation">,</span> address to<span class="token punctuation">,</span> uint amount<span class="token punctuation">)</span><span class="token punctuation">;</span>




    <span class="token comment">// 特殊函数 constructor 是仅在创建合约期间运行的构造函数，不能在创建之后调用。 </span>
    <span class="token comment">// 构造函数永久存储创建合约的人的地址: msg (类似的还有 tx 和 block ) 是一个特殊的全局变量    </span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        minter <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span> <span class="token comment">// msg.sender 始终记录当前（外部）函数调用是来自于哪一个地址。</span>
    <span class="token punctuation">}</span>

    

    <span class="token comment">// mint 函数用来新发行一定数量的币到一个地址</span>
    <span class="token keyword">function</span> <span class="token function">mint</span><span class="token punctuation">(</span><span class="token parameter">address receiver<span class="token punctuation">,</span> uint amount</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// require 用来检查某些条件，如果不满足这些条件就会回推所有的状态变化。</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> minter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保只有合约的创建者可以调用 mint</span>
        <span class="token comment">// 请注意，由于默认的 算术检查模式 ，如果表达式 balances[receiver] += amount 溢出交易将被还原。 即当任意精度算术中的 balances[receiver]+ amount 大于 uint (2**256 - 1)</span>
        balances<span class="token punctuation">[</span>receiver<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Errors allow you to provide information about</span>
    <span class="token comment">// why an operation failed. They are returned</span>
    <span class="token comment">// to the caller of the function.</span>
    <span class="token comment">// Errors 用来向调用者描述错误信息。Error与 revert 语句 一起使用; revert 语句无条件地中止执行并回退所有的变化，类似于 require 函数</span>
    error <span class="token function">InsufficientBalance</span><span class="token punctuation">(</span>uint requested<span class="token punctuation">,</span> uint available<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 任何人（已经拥有一些代币）都可以使用 send 函数来向其他人发送代币。</span>
    <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">address receiver<span class="token punctuation">,</span> uint amount</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果发送者没有足够的代币可以发送， if 条件为真 revert 将触发失败，并通过 InsufficientBalance 向发送者提供错误细节。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&gt;</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span>
            revert <span class="token function">InsufficientBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">requested</span><span class="token operator">:</span> amount<span class="token punctuation">,</span>
                <span class="token literal-property property">available</span><span class="token operator">:</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>receiver<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
        emit <span class="token function">Sent</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="公开拍卖合约"><a href="#公开拍卖合约" class="header-anchor">#</a> 公开拍卖合约</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
简单的公开拍卖
以下简单的拍卖合约的总体思路是每个人都可以在投标期内发送他们的出价。 出价已经包含了资金/以太币，来将投标人与他们的投标绑定。 如果最高出价提高了（被其他出价者的出价超过），之前出价最高的出价者可以拿回她的钱。 在投标期结束后，受益人需要手动调用合约来接收他的钱 - 合约不能自己激活接收。
 */</span>

<span class="token comment">// SPDX-License-Identifier: GPL-3.0</span>
pragma solidity <span class="token operator">^</span><span class="token number">0.8</span><span class="token number">.4</span><span class="token punctuation">;</span>

contract SimpleAuction <span class="token punctuation">{</span>
    <span class="token comment">// 拍卖的参数。</span>
    address payable <span class="token keyword">public</span> beneficiary<span class="token punctuation">;</span>
    <span class="token comment">// 时间是unix的绝对时间戳（自1970-01-01以来的秒数）</span>
    <span class="token comment">// 或以秒为单位的时间段。</span>
    uint <span class="token keyword">public</span> auctionEnd<span class="token punctuation">;</span>

    <span class="token comment">// 拍卖的当前状态</span>
    address <span class="token keyword">public</span> highestBidder<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> highestBid<span class="token punctuation">;</span>

    <span class="token comment">//可以取回的之前的出价</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span><span class="token parameter">address</span> <span class="token operator">=&gt;</span> uint<span class="token punctuation">)</span> pendingReturns<span class="token punctuation">;</span>

    <span class="token comment">// 拍卖结束后设为 true，将禁止所有的变更</span>
    bool ended<span class="token punctuation">;</span>

    <span class="token comment">// 变更触发的事件</span>
    event <span class="token function">HighestBidIncreased</span><span class="token punctuation">(</span>address bidder<span class="token punctuation">,</span> uint amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    event <span class="token function">AuctionEnded</span><span class="token punctuation">(</span>address winner<span class="token punctuation">,</span> uint amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Errors 用来定义失败</span>

    <span class="token comment">// 以下称为 natspec 注释，可以通过三个斜杠来识别。</span>
    <span class="token comment">// 当用户被要求确认交易时或错误发生时将显示。</span>

    <span class="token comment">/// The auction has already ended.</span>
    error <span class="token function">AuctionAlreadyEnded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// There is already a higher or equal bid.</span>
    error <span class="token function">BidNotHighEnough</span><span class="token punctuation">(</span>uint highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// The auction has not ended yet.</span>
    error <span class="token function">AuctionNotYetEnded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// The function auctionEnd has already been called.</span>
    error <span class="token function">AuctionEndAlreadyCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 以受益者地址 `beneficiaryAddress` 的名义，</span>
    <span class="token comment">/// 创建一个简单的拍卖，拍卖时间为 `biddingTime` 秒。</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>
        <span class="token parameter">uint biddingTime<span class="token punctuation">,</span>
        address payable beneficiaryAddress</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beneficiary <span class="token operator">=</span> beneficiaryAddress<span class="token punctuation">;</span>
        auctionEnd <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> biddingTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 对拍卖进行出价，具体的出价随交易一起发送。</span>
    <span class="token comment">/// 如果没有在拍卖中胜出，则返还出价。</span>
    <span class="token keyword">function</span> <span class="token function">bid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external payable <span class="token punctuation">{</span>
        <span class="token comment">// 参数不是必要的。因为所有的信息已经包含在了交易中。</span>
        <span class="token comment">// 对于能接收以太币的函数，关键字 payable 是必须的。</span>

        <span class="token comment">// 如果拍卖已结束，撤销函数的调用。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">&gt;</span> auctionEndTime<span class="token punctuation">)</span>
            revert <span class="token function">AuctionAlreadyEnded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果出价不够高，返还你的钱</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> highestBid<span class="token punctuation">)</span>
            revert <span class="token function">BidNotHighEnough</span><span class="token punctuation">(</span>highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>highestBid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返还出价时，简单地直接调用 highestBidder.send(highestBid) 函数，</span>
            <span class="token comment">// 是有安全风险的，因为它有可能执行一个非信任合约。</span>
            <span class="token comment">// 更为安全的做法是让接收方自己提取金钱。</span>
            pendingReturns<span class="token punctuation">[</span>highestBidder<span class="token punctuation">]</span> <span class="token operator">+=</span> highestBid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        highestBidder <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        highestBid <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        emit <span class="token function">HighestBidIncreased</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 取回出价（当该出价已被超越）</span>
    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token parameter">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint amount <span class="token operator">=</span> pendingReturns<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里很重要，首先要设零值。</span>
            <span class="token comment">// 因为，作为接收调用的一部分，</span>
            <span class="token comment">// 接收者可以在 `send` 返回之前，重新调用该函数。</span>
            pendingReturns<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment">// msg.sender is not of type `address payable` and must be</span>
            <span class="token comment">// explicitly converted using `payable(msg.sender)` in order</span>
            <span class="token comment">// use the member function `send()`.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这里不需抛出异常，只需重置未付款</span>
                pendingReturns<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> amount<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 结束拍卖，并把最高的出价发送给受益人</span>
    <span class="token keyword">function</span> <span class="token function">auctionEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> external <span class="token punctuation">{</span>
        <span class="token comment">// 对于可与其他合约交互的函数（意味着它会调用其他函数或发送以太币），</span>
        <span class="token comment">// 一个好的指导方针是将其结构分为三个阶段：</span>
        <span class="token comment">// 1. 检查条件</span>
        <span class="token comment">// 2. 执行动作 (可能会改变条件)</span>
        <span class="token comment">// 3. 与其他合约交互</span>
        <span class="token comment">// 如果这些阶段相混合，其他的合约可能会回调当前合约并修改状态，</span>
        <span class="token comment">// 或者导致某些效果（比如支付以太币）多次生效。</span>
        <span class="token comment">// 如果合约内调用的函数包含了与外部合约的交互，</span>
        <span class="token comment">// 则它也会被认为是与外部合约有交互的。</span>

        <span class="token comment">// 1. 条件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> auctionEndTime<span class="token punctuation">)</span>
            revert <span class="token function">AuctionNotYetEnded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ended<span class="token punctuation">)</span>
            revert <span class="token function">AuctionEndAlreadyCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 生效</span>
        ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        emit <span class="token function">AuctionEnded</span><span class="token punctuation">(</span>highestBidder<span class="token punctuation">,</span> highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 交互</span>
        beneficiary<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>highestBid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://www.it1129.com/2022/03/07/solidity-%e5%9f%ba%e7%a1%80%e5%85%a5%e9%97%a8%e7%b3%bb%e5%88%97/" target="_blank" rel="noopener noreferrer">SOLIDITY 基础入门系列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <a href="/more/web3/" class="fix-link" data-v-84d70020>Back</a></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/blog/tags/?tag=web3" title="标签">#web3</a><a href="/blog/tags/?tag=solidity" title="标签">#solidity</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/1/2022, 3:52:40 PM</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/project/mono-react-project.html"><div>
            MonoRepo——React项目实践
            <!----></div></a> <span class="date">09-11</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/more/jenkins-deploy.html"><div>
            Jenkins前端自动化部署
            <!----></div></a> <span class="date">08-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/more/docker-note.html"><div>
            Docker入门学习笔记
            <!----></div></a> <span class="date">08-05</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>一苇 | <a href="https://beian.miit.gov.cn/" target="_blank" style="font-weight:normal"><img src="/blog/images/icp.png" width="20" height="20" alt="公网备案"/>京ICP备2021006935号-2</a> </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><!----><!----><div></div></div></div>
    <script src="/blog/assets/js/app.a61e072d.js" defer></script><script src="/blog/assets/js/3.a2a245ac.js" defer></script><script src="/blog/assets/js/90.44324668.js" defer></script><script src="/blog/assets/js/4.245b4373.js" defer></script>
  </body>
</html>
